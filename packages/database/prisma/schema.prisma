generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ============================================
// SECTION 1: AUTHENTICATION & USER MANAGEMENT
// ============================================

// --- Enums for User Management ---

enum USER_TYPE {
    BUYER
    SELLER
}

enum USER_STATUS {
    ACTIVE
    BANNED
}

enum USER_VERIFICATION_STATUS {
    DEFAULT
    APPROVED
    PENDING
    REJECTED
}

enum ADMIN_STATUS {
    ACTIVE
    INACTIVE
}

enum MERCHANT_MODE {
    TEST
    LIVE
}

// --- User Models ---

model User {
    id                  String                   @id
    firstName           String
    lastName            String
    userName            String                   @unique
    email               String                   @unique
    business            String
    type                USER_TYPE                @default(BUYER)
    mobile              String
    password            String
    image               String?
    status              USER_STATUS              @default(ACTIVE)
    address             Json?
    emailVerified       Boolean                  @default(false)
    smsVerified         Boolean                  @default(false)
    kycVerified         USER_VERIFICATION_STATUS @default(DEFAULT)
    bankVerified        USER_VERIFICATION_STATUS @default(DEFAULT)
    gstVerified         USER_VERIFICATION_STATUS @default(DEFAULT)
    verificationCode    String?
    verificationSentAt  DateTime?
    twoFactorVerified   Boolean                  @default(false)
    twoFactorSecret     String?
    twoFactorQrCode     String?
    twoFactorStatus     Boolean                  @default(false)
    deviceId            String?
    emailVerifiedAt     DateTime?
    rememberToken       String?
    refreshToken        String?
    refreshTokenExpires DateTime?
    hasSoldBefore       Boolean                  @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    UserKycDetails   UserKycDetails?
    SellerAccount    SellerAccount?
    notifications    Notification[]
    listings         Listing[]
    userConnects     Connects[]       @relation("user")
    sellerConnects   Connects[]       @relation("seller")
    ordersBought     Order[]          @relation("order_buyer")
    ordersSold       Order[]          @relation("order_seller")
    PaymentsAsBuyer  Payment[]        @relation("PaymentBuyer")
    PaymentsAsSeller Payment[]        @relation("PaymentSeller")
    DisputeTicket    DisputeTicket[]
    Logistics        Logistics[]
    ShopCart         ShopCart[]
    ShopOrderGroup   ShopOrderGroup[]
    ShopPayment      ShopPayment[]

    @@map("users")
}

model UserKycDetails {
    id         String  @id
    userId     String? @unique
    merchantId String? @unique

    // PAN Details
    panNumber             String?
    dateOfBirth           String?
    fullNameAsPerPan      String?
    panVerificationStatus USER_VERIFICATION_STATUS @default(DEFAULT)
    panRejectionReason    String?

    // Aadhaar Details
    aadharNumber             String?
    fullNameAsPerAadhar      String?
    aadhaarReferenceId       String?
    aadharVerificationStatus USER_VERIFICATION_STATUS @default(DEFAULT)
    aadharRejectionReason    String?

    // GST Details
    gstNumber             String?
    gstStatus             String?
    constitution          String?
    registrationDate      String?
    businessName          String?
    businessAddress       Json?
    tradeName             String?
    gstVerificationStatus USER_VERIFICATION_STATUS @default(DEFAULT)
    gstRejectionReason    String?

    // Bank Details
    bankAccountNumber      String?
    bankIfscCode           String?
    fullNameAsPerBank      String?
    bankVerificationStatus USER_VERIFICATION_STATUS @default(DEFAULT)
    bankRejectionReason    String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    user     User?     @relation(fields: [userId], references: [id])
    Merchant Merchant? @relation(fields: [merchantId], references: [id])

    @@map("user_kyc_details")
}

model Admin {
    id        String       @id
    firstName String
    lastName  String
    userName  String       @unique
    email     String       @unique
    password  String
    image     String?
    status    ADMIN_STATUS @default(ACTIVE)

    emailVerified       Boolean   @default(false)
    emailVerifiedAt     DateTime?
    verificationCode    String?
    verificationSentAt  DateTime?
    refreshToken        String?
    refreshTokenExpires DateTime?

    roleId String
    role   AdminRole @relation(fields: [roleId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    DisputeTickets    DisputeTicket[]     @relation("AdminDisputes")
    ShopDisputeTicket ShopDisputeTicket[]

    @@map("admins")
}

model AdminRole {
    id          String  @id
    name        String  @unique
    description String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    admins      Admin[]
    permissions AdminPermission[] @relation("RolePermissions")

    @@map("admin_roles")
}

model AdminPermission {
    id    String  @id
    name  String  @unique
    label String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    roles AdminRole[] @relation("RolePermissions")

    @@map("admin_permissions")
}

model Merchant {
    id                  String                   @id
    firstName           String
    lastName            String
    userName            String                   @unique
    email               String                   @unique
    business            String
    mobile              String
    password            String
    image               String?
    status              USER_STATUS              @default(ACTIVE)
    address             Json?
    emailVerified       Boolean                  @default(false)
    smsVerified         Boolean                  @default(false)
    kycVerified         USER_VERIFICATION_STATUS @default(DEFAULT)
    bankVerified        USER_VERIFICATION_STATUS @default(DEFAULT)
    gstVerified         USER_VERIFICATION_STATUS @default(DEFAULT)
    verificationCode    String?
    verificationSentAt  DateTime?
    twoFactorVerified   Boolean                  @default(false)
    twoFactorQrCode     String?
    twoFactorSecret     String?
    twoFactorStatus     Boolean                  @default(false)
    deviceId            String?
    emailVerifiedAt     DateTime?
    rememberToken       String?
    refreshToken        String?
    refreshTokenExpires DateTime?
    mode                MERCHANT_MODE            @default(TEST)

    lastRotatedAt DateTime?
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt

    // Relations
    MerchantKycDetails        UserKycDetails?
    apiKeys                   MerchantApiKey[]
    webhooks                  MerchantWebhook[]
    ShopProduct               ShopProduct[]
    MerchantStore             MerchantStore[]
    ShopifyState              ShopifyState[]
    ShopOrder                 ShopOrder[]
    ShopPayment               ShopPayment[]
    MerchantPreferences       MerchantPreferences?
    MerchantCourierConfig     MerchantCourierConfig[]
    MerchantAccount           MerchantAccount?
    MerchantPlatformFee       MerchantPlatformFee[]
    BulkLogisticsJob          BulkLogisticsJob[]
    CourierPerformanceMetrics CourierPerformanceMetrics[]
    Manifest                  Manifest[]
    PickupAddresses           Address[]
    PackageProfiles           PackageProfile[]
}

// ============================================
// SECTION 2: SELLER & MERCHANT FINANCIAL MANAGEMENT
// ============================================

// --- Enums for Financial Management ---

enum ACCOUNT_STATUS {
    ACTIVE
    SUSPENDED
    CLOSED
}

enum PAYOUT_STATUS {
    PENDING
    SUCCESS
    FAILED
    CANCELLED
}

enum PAYOUT_METHOD {
    UPI
    BANK_TRANSFER
    RAZORPAY
}

enum PAYOUT_FREQUENCY {
    MANUAL
    WEEKLY
    MONTHLY
}

enum DEDUCTION_TYPE {
    SHIPPING
    REVERSE_DELIVERY
    COD_CHARGE
    PENALTY
    PLATFORM_FEE
    DISPUTE_RESOLUTION
    MANUAL_ADJUSTMENT
}

enum DEDUCTION_STATUS {
    PENDING
    SETTLED
    WAIVED
}

enum DEDUCTION_SOURCE {
    SYSTEM
    ADMIN
    MERCHANT
}

// --- Seller Account Models (Marketplace) ---

model SellerAccount {
    id     String @id
    userId String @unique
    user   User   @relation(fields: [userId], references: [id])

    earningsBalance Float @default(0.0)
    creditBalance   Float @default(0.0)
    totalEarnings   Float @default(0.0)
    totalWithdrawn  Float @default(0.0)
    totalCharges    Float @default(0.0)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    SellerDeduction SellerDeduction[]
}

model SellerDeduction {
    id              String           @id
    sellerAccountId String
    sellerAccount   SellerAccount    @relation(fields: [sellerAccountId], references: [id])
    orderId         String
    type            DEDUCTION_TYPE
    amount          Float
    status          DEDUCTION_STATUS

    createdAt DateTime @default(now())
}

// --- Merchant Account Models (E-commerce) ---

model MerchantAccount {
    id         String   @id
    merchantId String   @unique
    merchant   Merchant @relation(fields: [merchantId], references: [id])

    availableBalance Float          @default(0.0)
    pendingCharges   Float          @default(0.0)
    totalEarnings    Float          @default(0.0)
    totalWithdrawn   Float          @default(0.0)
    totalCharges     Float          @default(0.0)
    currency         String         @default("INR")
    status           ACCOUNT_STATUS @default(ACTIVE)

    payoutMethod    PAYOUT_METHOD?
    lastPayoutAt    DateTime?
    payoutFrequency PAYOUT_FREQUENCY @default(MANUAL)

    auditTrail Json?
    notes      String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    deductions        MerchantDeduction[]
    PayoutTransaction PayoutTransaction[]
}

model MerchantDeduction {
    id                String          @id
    merchantAccountId String
    merchantAccount   MerchantAccount @relation(fields: [merchantAccountId], references: [id])

    referenceId String // Order ID or Shipping ID
    type        DEDUCTION_TYPE
    amount      Float
    status      DEDUCTION_STATUS @default(PENDING)
    remarks     String?

    triggeredBy DEDUCTION_SOURCE @default(SYSTEM)
    settledAt   DateTime?
    waivedBy    String?

    // ===== RTO LINK (NEW) ===== //
    shippingId String? // Link to Shipping if RTO-related

    createdAt DateTime @default(now())
}

model PayoutTransaction {
    id                String          @id
    merchantAccountId String
    merchantAccount   MerchantAccount @relation(fields: [merchantAccountId], references: [id])

    amount        Float
    method        PAYOUT_METHOD
    status        PAYOUT_STATUS @default(PENDING)
    externalTxnId String?
    referenceNote String?
    failureReason String?
    initiatedBy   String

    createdAt   DateTime  @default(now())
    processedAt DateTime?
}

// ============================================
// SECTION 3: MARKETPLACE (P2P TRADING)
// ============================================

// --- Enums for Marketplace ---

enum LISTING_TYPE {
    PRODUCT
    SERVICE
}

enum LISTING_STATUS {
    ACTIVE
    INACTIVE
    BLOCKED
}

enum CONNECT_STATUS {
    PENDING
    ACCEPTED
    REJECTED
    CLOSED
}

enum ORDER_TYPE {
    CUSTOM
    PRODUCT
    SERVICE
}

enum PLATFORM_FEE_PAYER {
    BUYER
    SELLER
    BOTH
}

enum CHARGE_PAYER {
    BUYER
    SELLER
}

enum MARKETPLACE_ORDER_STATUS {
    PENDING
    CREATED
    PAID
    ON_HOLD
    FINISHED
    ON_DISPUTE
    RELEASED
    REFUNDED
    CANCELLED
}

enum ORDER_FLOW_STATUS {
    PENDING
    APPROVED
    REJECTED
}

// --- Listing Models ---

model Listing {
    id           String         @id
    sellerId     String
    type         LISTING_TYPE
    title        String
    description  String
    category     String
    subCategory  String?
    price        Float
    status       LISTING_STATUS @default(ACTIVE)
    tags         String[]
    metadata     Json?
    media        Json?
    externalLink String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    seller       User           @relation(fields: [sellerId], references: [id])
    connects     Connects[]
    conversation Conversation[]
    Order        Order[]
    OrderDetails OrderDetails[]

    @@index([sellerId])
    @@index([status])
    @@index([type])
    @@map("listings")
}

model Connects {
    id        String         @id
    userId    String
    listingId String?
    sellerId  String
    message   String?        @db.VarChar(500)
    status    CONNECT_STATUS @default(PENDING)

    rejectReason String? @db.VarChar(500)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    user    User     @relation("user", fields: [userId], references: [id])
    seller  User     @relation("seller", fields: [sellerId], references: [id])
    listing Listing? @relation(fields: [listingId], references: [id])

    @@index([userId])
    @@index([sellerId])
    @@index([listingId])
    @@map("connects")
}

// --- Order Models ---

model Order {
    id        String                   @id
    orderType ORDER_TYPE
    buyerId   String
    sellerId  String
    status    MARKETPLACE_ORDER_STATUS @default(PENDING)
    notes     String?

    orderStatus  ORDER_FLOW_STATUS @default(PENDING)
    rejectReason String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    listingId String?

    // Relations
    buyer         User           @relation("order_buyer", fields: [buyerId], references: [id])
    seller        User           @relation("order_seller", fields: [sellerId], references: [id])
    listing       Listing?       @relation(fields: [listingId], references: [id])
    details       OrderDetails?
    transaction   Transaction?
    conversations Conversation[]
    payments      Payment[]
    dispute       DisputeTicket?
    refunds       Refund[]
}

model OrderDetails {
    id String @id

    orderType ORDER_TYPE

    listingId      String?
    listingDetails Json?
    customDetails  Json?

    totalAmount      Float
    platformFee      Float
    platformFeePayer PLATFORM_FEE_PAYER @default(BUYER)
    sellerReceives   Float
    buyerAmount      Float

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    orderId String @unique

    // Relations
    listing          Listing?           @relation(fields: [listingId], references: [id])
    order            Order              @relation(fields: [orderId], references: [id])
    orderAttachments orderAttachments[]
}

model orderAttachments {
    id             String       @id
    orderDetailsId String
    OrderDetails   OrderDetails @relation(fields: [orderDetailsId], references: [id])

    type     String
    url      String
    name     String
    publicId String

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// --- Transaction & Payment Models ---

enum TRANSACTION_STATUS {
    INITIATED
    ON_HOLD
    AWAITING_RELEASE
    RELEASED_TO_SELLER
    REFUND_PENDING
    REFUNDED_TO_BUYER
    DISPUTED
    CANCELLED
    FAILED
}

enum PAYMENT_METHOD {
    PREPAID
    POD
    COD
}

enum PAYMENT_STATUS {
    INITIATED
    AUTHORIZED
    CAPTURED
    FAILED
    REFUNDED
    PARTIALLY_REFUNDED
    COD_PENDING
    COD_COLLECTED
    COD_FAILED
}

enum USER_ROLE {
    BUYER
    SELLER
    MERCHANT
    ADMIN
    GUEST
}

model Transaction {
    id      String @id
    orderId String @unique

    buyerPaid       Float
    chargesDeducted Float
    sellerReceives  Float

    status                   TRANSACTION_STATUS @default(INITIATED)
    releaseRequested         Boolean            @default(false)
    releaseRequestedAt       DateTime?
    releaseRequestedByType   USER_ROLE?
    releaseRequestedById     String?
    releaseRequestedMeta     Json?
    releaseApprovedByAdmin   Boolean            @default(false)
    releaseApprovedAt        DateTime?
    releaseApprovedByAdminId String?
    releaseNotes             String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    order    Order     @relation(fields: [orderId], references: [id])
    payments Payment[]
    refunds  Refund[]
}

model Payment {
    id String @id

    orderId       String
    transactionId String
    buyerId       String
    sellerId      String

    amount   Float
    currency String @default("INR")

    method PAYMENT_METHOD @default(PREPAID)
    status PAYMENT_STATUS @default(INITIATED)

    razorpayOrderId   String?
    razorpayPaymentId String?
    providerTxnId     String?

    errorCode    String?
    errorMessage String?

    metadata Json?

    paidAt  DateTime?
    attempt Int       @default(1)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    transaction Transaction @relation(fields: [transactionId], references: [id])
    order       Order       @relation(fields: [orderId], references: [id])
    buyer       User?       @relation("PaymentBuyer", fields: [buyerId], references: [id])
    seller      User?       @relation("PaymentSeller", fields: [sellerId], references: [id])

    @@index([orderId, transactionId])
}

// ============================================
// SECTION 4: E-COMMERCE STORE MANAGEMENT
// ============================================

// --- Enums for Store Management ---

enum STORE_TYPE {
    SHOPIFY
    WOOCOMMERCE
}

enum STORE_CONNECTION_TYPE {
    OAUTH
    MANUAL
}

enum STORE_STATUS {
    ACTIVE
    INACTIVE
    BLOCKED
}

enum SYNC_STATUS {
    IDLE
    SYNCING
    ERROR
    COMPLETED
}

enum API_STATUS {
    ENABLED
    DISABLED
    REVOKED
}

enum NotificationEvent {
    PAYMENT_SUCCESS
    PAYMENT_FAILED
    ORDER_CREATED
    ORDER_DISPUTE
    REFUND_PROCESSED
}

enum REMITTANCE_CYCLE {
    DAILY
    WEEKLY
    ON_DELIVERY
}

enum WEBHOOK_TOPIC {
    ORDERS_CREATE
    ORDERS_UPDATE
    ORDERS_CANCELLED
    ORDERS_PAID
    PRODUCTS_CREATE
    PRODUCTS_UPDATE
    PRODUCTS_DELETE
    INVENTORY_UPDATE
    CHECKOUTS_CREATE
    CHECKOUTS_UPDATE
    APP_UNINSTALLED
    SHOP_UPDATE
    CUSTOMERS_CREATE
    CUSTOMERS_UPDATE
}

enum WEBHOOK_STATUS {
    ACTIVE
    INACTIVE
    FAILED
}

enum SESSION_STATUS {
    ACTIVE
    COMPLETED
    ABANDONED
    EXPIRED
}

enum SYNC_TYPE {
    PRODUCTS
    ORDERS
    INVENTORY
    CUSTOMERS
    WEBHOOKS
    FULL_SYNC
}

enum SYNC_RESULT {
    SUCCESS
    PARTIAL
    FAILED
}

enum SUBSCRIPTION_STATUS {
    ACTIVE
    TRIAL
    CANCELLED
    PAST_DUE
    EXPIRED
}

enum PLAN_TYPE {
    FREE
    STARTER
    PROFESSIONAL
    ENTERPRISE
    CUSTOM
}

// --- Store Models ---

model MerchantStore {
    id         String   @id
    merchantId String
    merchant   Merchant @relation(fields: [merchantId], references: [id])

    // ===== STORE IDENTIFICATION ===== //
    storeType    STORE_TYPE
    storeName    String
    storeUrl     String // myshop.myshopify.com
    customDomain String? // www.myshop.com
    storeSlug    String?    @unique // for RakshaSetu URLs (checkout.rakshasetu.com/store-slug)
    externalId   String? // Shopify's store ID

    // ===== CONNECTION & AUTH ===== //
    connectionType STORE_CONNECTION_TYPE
    status         STORE_STATUS          @default(ACTIVE)
    isActive       Boolean               @default(true)

    // OAuth credentials (encrypted)
    apiKey      String?
    apiSecret   String?
    scopes      String?
    accessToken String?

    // ===== INSTALLATION TRACKING ===== //
    installedAt       DateTime?
    uninstalledAt     DateTime?
    lastActiveAt      DateTime? // Last API call or webhook received
    installationCount Int       @default(1) // Track reinstalls

    // ===== SHOPIFY SPECIFIC ===== //
    shopifyPlan        String? // "basic", "shopify", "advanced", "plus"
    shopifyPlanName    String?
    isTestStore        Boolean @default(false)
    isPartnerTestStore Boolean @default(false)

    // ===== STORE INFO ===== //
    storeOwnerName   String?
    storeOwnerEmail  String?
    storePhone       String?
    storeTimezone    String? @default("Asia/Kolkata")
    storeCurrency    String  @default("INR")
    storeCountryCode String? @default("IN")
    storeLanguage    String  @default("en")
    storeAddress     Json? // Full address object

    // ===== SYNC STATUS ===== //
    syncStatus            SYNC_STATUS @default(IDLE)
    connectedAt           DateTime?
    lastProductsSyncedAt  DateTime?
    lastOrdersSyncedAt    DateTime?
    lastStoreSyncedAt     DateTime?
    lastWebhookReceivedAt DateTime?

    // Sync settings
    autoSyncProducts  Boolean @default(true)
    autoSyncOrders    Boolean @default(true)
    autoSyncInventory Boolean @default(false)
    syncInterval      Int     @default(30) // Minutes

    // Sync health
    syncErrorCount  Int       @default(0)
    lastSyncError   String?
    lastSyncErrorAt DateTime?

    // ===== CUSTOM CHECKOUT ===== //
    customCheckoutEnabled Boolean @default(false)
    checkoutUrl           String? // checkout.rakshasetu.com/store-slug
    checkoutSettings      Json?
    // {
    //   "theme": "light",
    //   "primaryColor": "#000000",
    //   "logo": "https://...",
    //   "showBranding": true,
    //   "requiredFields": ["phone"],
    //   "enableGuestCheckout": true,
    //   "thankYouPageUrl": "https://...",
    //   "enableCOD": true,
    //   "codCharge": 50
    // }

    // Script injection
    scriptTagId      String? // Shopify script tag ID
    scriptInjectedAt DateTime?
    scriptActive     Boolean   @default(false)
    scriptVersion    String?   @default("1.0.0")

    // ===== FEATURES & LIMITS ===== //
    features Json? // Enabled features
    // {
    //   "bulkShipping": true,
    //   "autoAssign": true,
    //   "advancedAnalytics": false,
    //   "whiteLabel": false
    // }

    // Quotas
    orderQuotaLimit   Int? // Max orders per billing cycle
    orderQuotaUsed    Int       @default(0)
    orderQuotaResetAt DateTime?

    // ===== CUSTOMIZATION ===== //
    metadata        Json?
    dashboardLayout Json?
    themeColor      String?
    customLabels    Json?

    // ===== COMPLIANCE & LEGAL ===== //
    gdprCompliant     Boolean   @default(false)
    privacyPolicyUrl  String?
    termsAcceptedAt   DateTime?
    dataRetentionDays Int?      @default(90)

    // ===== PERFORMANCE METRICS ===== //
    totalOrders       Int   @default(0)
    totalRevenue      Float @default(0)
    averageOrderValue Float @default(0)
    conversionRate    Float @default(0)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    products                    ShopProduct[]
    ShopOrder                   ShopOrder[]
    preferences                 MerchantStorePreferences?
    MerchantStorePickupAddress  MerchantStorePickupAddress[]
    MerchantStorePackageProfile MerchantStorePackageProfile[]
    MerchantStoreCourierConfig  MerchantStoreCourierConfig[]
    StorePlatformFee            StorePlatformFee[]
    BulkLogisticsJob            BulkLogisticsJob[]
    CourierPerformanceMetrics   CourierPerformanceMetrics[]
    Manifest                    Manifest[]
    StoreWebhook                StoreWebhook[]
    StoreSession                StoreSession[]
    StoreAnalytics              StoreAnalytics[]
    StoreNotificationSettings   StoreNotificationSettings?
    StoreSubscription           StoreSubscription?
    StoreSyncLog                StoreSyncLog[]

    @@index([merchantId])
    @@index([storeUrl])
    @@index([storeSlug])
    @@index([externalId])
    @@index([status, isActive])
    @@index([lastActiveAt])
}

model StoreWebhook {
    id      String        @id
    storeId String
    store   MerchantStore @relation(fields: [storeId], references: [id])

    topic     WEBHOOK_TOPIC
    webhookId String? // Shopify's webhook ID
    address   String // Our webhook URL
    status    WEBHOOK_STATUS @default(ACTIVE)

    lastFiredAt   DateTime?
    lastSuccessAt DateTime?
    failureCount  Int       @default(0)
    lastFailureAt DateTime?
    lastError     String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([storeId, topic])
    @@index([storeId, status])
}

model StoreSession {
    id      String        @id
    storeId String
    store   MerchantStore @relation(fields: [storeId], references: [id])

    sessionToken String  @unique
    cartId       String? // Shopify cart ID
    checkoutId   String? // Shopify checkout ID
    customerId   String? // Shopify customer ID

    cartData     Json? // Cart contents snapshot
    customerData Json? // Customer info
    checkoutUrl  String? // RakshaSetu checkout URL

    status SESSION_STATUS @default(ACTIVE)

    // Analytics
    ipAddress   String?
    userAgent   String?
    referrer    String?
    utmSource   String?
    utmMedium   String?
    utmCampaign String?

    // Timestamps
    startedAt   DateTime  @default(now())
    completedAt DateTime?
    abandonedAt DateTime?
    expiresAt   DateTime

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([storeId, status])
    @@index([sessionToken])
    @@index([expiresAt])
    @@index([startedAt])
}

model StoreAnalytics {
    id      String        @id
    storeId String
    store   MerchantStore @relation(fields: [storeId], references: [id])
    date    DateTime // Day bucket

    // Orders
    totalOrders       Int   @default(0)
    completedOrders   Int   @default(0)
    cancelledOrders   Int   @default(0)
    totalRevenue      Float @default(0)
    averageOrderValue Float @default(0)

    // Checkout
    checkoutSessions    Int   @default(0)
    checkoutCompletions Int   @default(0)
    checkoutAbandonment Int   @default(0)
    conversionRate      Float @default(0)

    // Products
    totalProducts      Int @default(0)
    productsOutOfStock Int @default(0)
    productsSynced     Int @default(0)

    // Logistics
    ordersShipped   Int @default(0)
    ordersDelivered Int @default(0)
    ordersReturned  Int @default(0)

    // Webhooks
    webhooksReceived Int @default(0)
    webhooksFailed   Int @default(0)

    // Traffic
    uniqueVisitors Int @default(0)
    pageViews      Int @default(0)

    calculatedAt DateTime @default(now())

    @@unique([storeId, date])
    @@index([storeId])
    @@index([date])
}

model StoreNotificationSettings {
    id      String        @id
    storeId String        @unique
    store   MerchantStore @relation(fields: [storeId], references: [id])

    // Email notifications
    emailOnNewOrder  Boolean @default(true)
    emailOnShipment  Boolean @default(true)
    emailOnDelivery  Boolean @default(true)
    emailOnReturn    Boolean @default(true)
    emailOnLowStock  Boolean @default(false)
    emailOnSyncError Boolean @default(true)

    // Additional recipients
    notificationEmails String[] // Extra emails to notify

    // Webhook notifications
    webhookUrl    String?
    webhookEvents Json? // Which events to send

    // Slack/Discord
    slackWebhook   String?
    discordWebhook String?

    // SMS (future)
    smsEnabled      Boolean  @default(false)
    smsPhoneNumbers String[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model StoreSubscription {
    id      String        @id
    storeId String        @unique
    store   MerchantStore @relation(fields: [storeId], references: [id])

    planType        PLAN_TYPE @default(FREE)
    billingInterval String    @default("MONTHLY") // MONTHLY, YEARLY
    price           Float     @default(0)
    currency        String    @default("INR")

    // Limits
    orderLimit    Int? // Max orders per billing cycle
    featureAccess Json // Which features enabled

    // Billing cycle
    currentPeriodStart DateTime
    currentPeriodEnd   DateTime
    nextBillingDate    DateTime?

    // Status
    status             SUBSCRIPTION_STATUS @default(TRIAL)
    trialEndsAt        DateTime?
    cancelledAt        DateTime?
    cancellationReason String?

    // Payment
    razorpaySubscriptionId String?
    lastPaymentAt          DateTime?
    lastPaymentAmount      Float?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([storeId])
    @@index([status])
}

model StoreSyncLog {
    id      String        @id
    storeId String
    store   MerchantStore @relation(fields: [storeId], references: [id])

    syncType SYNC_TYPE
    result   SYNC_RESULT

    // Stats
    totalItems   Int
    successItems Int
    failedItems  Int

    // Details
    startedAt   DateTime  @default(now())
    completedAt DateTime?
    durationMs  Int?

    errorMessage String?
    errorDetails Json?

    // Metadata
    triggeredBy     String? // "AUTO", "MANUAL", "WEBHOOK"
    triggeredByUser String? // User ID if manual

    createdAt DateTime @default(now())

    @@index([storeId, syncType])
    @@index([startedAt])
}

model MerchantStorePreferences {
    id      String        @id
    storeId String        @unique
    store   MerchantStore @relation(fields: [storeId], references: [id])

    // üîÑ Override Control
    overrideMerchantPrefs Boolean @default(false)

    // ===== PACKAGE SETTINGS (CHANGED) ===== //
    useCustomPackageProfile Boolean         @default(false) // If true, use MerchantStorePackageProfile (isDefault)
    customPackageProfileId  String? // OR link to specific PackageProfile
    customPackageProfile    PackageProfile? @relation("StoreCustomPackage", fields: [customPackageProfileId], references: [id])

    // ===== PICKUP ADDRESS SETTINGS ===== //
    useCustomPickupAddress Boolean  @default(false)
    customPickupAddressId  String?
    customPickupAddress    Address? @relation("StoreCustomPickup", fields: [customPickupAddressId], references: [id])

    // ===== QUOTE SETTINGS ===== //
    sortQuotesBy       String?
    quoteCacheDuration Int?

    // ===== COD SETTINGS ===== //
    codEnabled       Boolean?
    codMinOrderValue Float?

    // ===== OTHER SETTINGS ===== //
    slaThresholdDays    Int?
    returnPolicy        Json?
    remittanceCycle     REMITTANCE_CYCLE @default(WEEKLY)
    // üõ†Ô∏è Admin
    allowManualOverride Boolean          @default(true)
    updatedBy           String?
    updatedAt           DateTime         @updatedAt
    createdAt           DateTime         @default(now())
}

model MerchantStorePickupAddress {
    id        String  @id
    storeId   String
    addressId String
    isDefault Boolean @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    store   MerchantStore @relation(fields: [storeId], references: [id])
    address Address       @relation(fields: [addressId], references: [id])
}

model MerchantStorePackageProfile {
    id               String  @id
    storeId          String
    packageProfileId String
    isDefault        Boolean @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    store          MerchantStore  @relation(fields: [storeId], references: [id])
    packageProfile PackageProfile @relation(fields: [packageProfileId], references: [id])

    @@unique([storeId, packageProfileId]) // Store can't link same profile twice
}

// --- Integration Models ---

model MerchantApiKey {
    id         String   @id
    merchantId String
    merchant   Merchant @relation(fields: [merchantId], references: [id])

    publicKey  String        @unique
    secretHash String
    scopes     String[]
    mode       MERCHANT_MODE
    status     API_STATUS

    createdAt  DateTime  @default(now())
    lastUsedAt DateTime?
    revokedAt  DateTime?
}

model MerchantWebhook {
    id         String   @id
    merchantId String
    merchant   Merchant @relation(fields: [merchantId], references: [id])

    url    String
    events NotificationEvent[]

    createdAt DateTime @default(now())
}

model MerchantPreferences {
    id         String   @id
    merchantId String   @unique
    merchant   Merchant @relation(fields: [merchantId], references: [id])

    // üì¶ Default Package Profile (CHANGED)
    defaultPackageProfileId String?
    defaultPackageProfile   PackageProfile? @relation("MerchantDefaultPackage", fields: [defaultPackageProfileId], references: [id])

    // üìç Default Pickup Address
    defaultPickupAddressId String?
    defaultPickupAddress   Address? @relation("MerchantDefaultPickup", fields: [defaultPickupAddressId], references: [id])

    // üöö Quote Settings
    sortQuotesBy       String @default("PRICE")
    quoteCacheDuration Int    @default(15)

    // üí∞ COD Settings
    codEnabled       Boolean @default(true)
    codMinOrderValue Float?  @default(0)

    // üì¶ Return Policy
    returnPolicy Json?

    // üìà SLA & Remittance
    slaThresholdDays Int?
    remittanceCycle  REMITTANCE_CYCLE

    // üõ†Ô∏è Admin
    allowManualOverride Boolean  @default(true)
    updatedBy           String?
    updatedAt           DateTime @updatedAt
    createdAt           DateTime @default(now())
}

// --- Shopify Integration Models ---

model ShopifyState {
    id         String   @id
    merchantId String
    shopUrl    String
    state      String   @unique
    expiresAt  DateTime

    merchant  Merchant @relation(fields: [merchantId], references: [id])
    createdAt DateTime @default(now())
}

model ShopifyTempSession {
    id          String    @id @default(cuid())
    shop        String    @unique
    accessToken String
    scope       String?
    expiresAt   DateTime?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
}

model ShopifyCheckoutSession {
    id              String   @id @default(cuid())
    storeDomain     String
    ownerEmail      String
    cartPayload     Json
    customerPayload Json
    createdAt       DateTime @default(now())
    expiresAt       DateTime

    @@index([storeDomain])
    @@index([ownerEmail])
    @@index([expiresAt])
}

// ============================================
// SECTION 5: SHOPPING CART & PRODUCTS
// ============================================

// --- Enums for Cart & Products ---

enum CartStatus {
    ACTIVE
    CHECKED_OUT
    ABANDONED
    EXPIRED
}

// --- Product Models ---
model ShopProduct {
    id          String  @id
    merchantId  String
    storeId     String
    externalId  String  @unique
    source      String
    title       String
    description String?
    imageUrl    String?
    price       Float
    currency    String  @default("INR")

    // ===== ADD THESE FIELDS ===== //
    weight Float? // grams
    length Float? // cm
    width  Float? // cm
    height Float? // cm

    // ===== EXISTING FIELDS (keep as is) ===== //
    inventoryQty  Int?
    sku           String?
    barcode       String?
    isAvailable   Boolean   @default(true)
    lastFetchedAt DateTime?
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt

    // Relations
    merchant            Merchant             @relation(fields: [merchantId], references: [id])
    store               MerchantStore        @relation(fields: [storeId], references: [id])
    cartItems           ShopCartItem[]
    ShopProductVariants ShopProductVariant[]
    ShopOrderItem       ShopOrderItem[]
}

model ShopProductVariant {
    id           String      @id
    productId    String
    product      ShopProduct @relation(fields: [productId], references: [id])
    externalId   String      @unique
    title        String
    price        Float
    sku          String?
    barcode      String?
    inventoryQty Int?
    isAvailable  Boolean     @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    ShopOrderItem ShopOrderItem[]
    ShopCartItem  ShopCartItem[]
}

// --- Cart Models ---

model ShopCart {
    id     String     @id @default(cuid())
    status CartStatus @default(ACTIVE)

    userId String? @unique
    user   User?   @relation(fields: [userId], references: [id])

    guestSessionTokenId String?            @unique
    guestSessionToken   GuestSessionToken? @relation(fields: [guestSessionTokenId], references: [id])

    expiresAt   DateTime?
    totalItems  Int       @default(0)
    totalAmount Float     @default(0)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    items ShopCartItem[]
}

model ShopCartItem {
    id     String   @id
    cartId String
    cart   ShopCart @relation(fields: [cartId], references: [id], onDelete: Cascade)

    shopProductId        String
    shopProduct          ShopProduct        @relation(fields: [shopProductId], references: [id], onDelete: Cascade)
    shopProductVariantId String
    variant              ShopProductVariant @relation(fields: [shopProductVariantId], references: [id])

    quantity      Int
    priceSnapshot Float
    metadata      Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// --- Guest Session Model ---

model GuestSessionToken {
    id      String @id @default(cuid())
    token   String @unique
    guestId String

    guestInfo Json?
    expiresAt DateTime?
    revoked   Boolean   @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    shopCart        ShopCart?
    ShopPayment     ShopPayment[]
    ShopOrder       ShopOrder[]
    ShopTransaction ShopTransaction[]
    ShopOrderGroup  ShopOrderGroup[]
}

// ============================================
// SECTION 6: E-COMMERCE ORDERS
// ============================================

// --- Enums for E-commerce Orders ---

enum SHOP_ORDER_SOURCE {
    SHOPIFY
    RAKSHASETU
    WOOCOMMERCE
}

enum ORDER_STATUS {
    CREATED
    PAYMENT_PENDING
    PAYMENT_RECEIVED
    READY_FOR_PICKUP
    PICKED_UP
    IN_TRANSIT
    OUT_FOR_DELIVERY
    DELIVERED
    RETURN_REQUESTED
    RETURN_IN_TRANSIT
    RETURNED
    CANCELLED
    FAILED_DELIVERY
    DISPUTE_OPEN
    DISPUTE_RESOLVED
    REFUND_INITIATED
    REFUND_COMPLETED
}

enum ESCROW_STATUS {
    INITIATED
    HELD
    RELEASE_REQUESTED
    RELEASED
    DISPUTE_OPEN
    DISPUTE_RESOLVED
    REFUNDED
}

enum SHOP_PLATFORM_FEE_PAYER {
    MERCHANT
    CUSTOMER
}

enum FULFILLMENT_STATUS {
    UNFULFILLED
    PARTIALLY_FULFILLED
    FULFILLED
    CANCELLED
}

enum PAYMENT_ORDER_SOURCE {
    CHECKOUT
    API
    MARKETPLACE
    SHOP
}

enum ORDER_GROUP_SOURCE {
    RAKSHASETU
    SHOPIFY
    WOOCOMMERCE
    MANUAL
}

enum ORDER_GROUP_STATUS {
    PENDING
    PARTIALLY_FULFILLED
    FULFILLED
    CANCELLED
    DISPUTED
}

enum ORDER_GROUP_TYPE {
    MARKETPLACE
    SINGLE_STORE
    BULK_IMPORT
}

// --- Order Group Models ---

model ShopOrderGroup {
    id      String  @id
    buyerId String?
    buyer   User?   @relation(fields: [buyerId], references: [id])

    guestSessionTokenId String?
    guestSessionToken   GuestSessionToken? @relation(fields: [guestSessionTokenId], references: [id])

    createdAt  DateTime           @default(now())
    externalId String?            @unique
    source     ORDER_GROUP_SOURCE @default(RAKSHASETU)

    status          ORDER_GROUP_STATUS @default(PENDING)
    totalAmount     Float              @default(0)
    currency        String             @default("INR")
    groupType       ORDER_GROUP_TYPE   @default(MARKETPLACE)
    groupNotes      String?
    deliverySummary Json?

    // Relations
    orders      ShopOrder[]
    ShopPayment ShopPayment[]

    @@index([buyerId])
    @@index([guestSessionTokenId])
    @@index([createdAt])
}

// --- Order Models ---

model ShopOrder {
    id         String            @id
    externalId String?           @unique
    source     SHOP_ORDER_SOURCE
    merchantId String
    storeId    String

    name        String?
    createdAt   DateTime  @default(now())
    processedAt DateTime?
    syncedAt    DateTime?

    currency       String @default("INR")
    totalPrice     Float
    subtotalPrice  Float?
    totalTax       Float?
    totalDiscounts Float?

    financialStatus   PAYMENT_STATUS?
    fulfillmentStatus FULFILLMENT_STATUS?
    sourceName        String?

    paymentGateway String?
    discountCodes  Json?
    shippingLines  Json?

    note String?
    tags String?

    customerId    String?
    customerName  String?
    customerEmail String?
    customerPhone String?

    shippingAddress Json?
    billingAddress  Json?

    packageDetails Json?

    guestSessionTokenId String?
    guestSessionToken   GuestSessionToken? @relation(fields: [guestSessionTokenId], references: [id])

    status ORDER_STATUS @default(CREATED)

    paymentType    PAYMENT_METHOD?
    shippingCharge Float?
    codCharge      Float?
    platformFee    Float?

    isEscrowed   Boolean        @default(false)
    escrowStatus ESCROW_STATUS?
    escrowMeta   Json?

    shopOrderGroupId String?

    // Relations
    merchant       Merchant           @relation(fields: [merchantId], references: [id])
    store          MerchantStore      @relation(fields: [storeId], references: [id])
    ShopOrderGroup ShopOrderGroup?    @relation(fields: [shopOrderGroupId], references: [id])
    lineItems      ShopOrderItem[]
    transaction    ShopTransaction?
    dispute        ShopDisputeTicket?
    refunds        ShopRefund[]
    ReturnRequest  ReturnRequest[]
    Shipping       Shipping[]
    Logistics      Logistics[]
}

model ShopOrderItem {
    id        String  @id
    orderId   String
    productId String
    variantId String?

    externalId        String
    title             String
    quantity          Int
    price             Float
    sku               String?
    fulfillmentStatus String?

    isReturnable     Boolean @default(true)
    returnWindowDays Int?

    // Relations
    order         ShopOrder           @relation(fields: [orderId], references: [id])
    product       ShopProduct         @relation(fields: [productId], references: [id])
    variant       ShopProductVariant? @relation(fields: [variantId], references: [id])
    ReturnRequest ReturnRequest[]
}

// --- Transaction Models ---

model ShopTransaction {
    id      String @id
    orderId String @unique

    buyerPaid       Float
    chargesDeducted Float
    sellerReceives  Float

    platformFee      Float?
    platformFeePayer SHOP_PLATFORM_FEE_PAYER @default(MERCHANT)
    shippingCharge   Float?
    codCharge        Float?

    status                   TRANSACTION_STATUS @default(INITIATED)
    releaseRequested         Boolean            @default(false)
    releaseRequestedAt       DateTime?
    releaseRequestedByType   USER_ROLE?
    releaseRequestedById     String?
    releaseRequestedMeta     Json?
    releaseApprovedByAdmin   Boolean            @default(false)
    releaseApprovedAt        DateTime?
    releaseApprovedByAdminId String?
    releaseNotes             String?

    releaseRequestedByGuestTokenId String?
    releaseRequestedByGuestToken   GuestSessionToken? @relation(fields: [releaseRequestedByGuestTokenId], references: [id])

    codRemittanceDueAt DateTime?
    codRemittedAt      DateTime?
    codRemittanceNotes String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    order   ShopOrder    @relation(fields: [orderId], references: [id])
    refunds ShopRefund[]
}

// --- Payment Models ---

model ShopPayment {
    id String @id

    buyerId    String?
    merchantId String?

    amount   Float
    currency String @default("INR")

    method PAYMENT_METHOD
    status PAYMENT_STATUS       @default(INITIATED)
    source PAYMENT_ORDER_SOURCE @default(SHOP)

    razorpayOrderId   String?
    razorpayPaymentId String?
    providerTxnId     String?

    errorCode    String?
    errorMessage String?
    metadata     Json?

    paidAt  DateTime?
    attempt Int       @default(1)

    codCollected   Boolean   @default(false)
    codCollectedAt DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    guestSessionTokenId String?
    guestSessionToken   GuestSessionToken? @relation(fields: [guestSessionTokenId], references: [id])

    orderGroupId   String         @unique
    shopOrderGroup ShopOrderGroup @relation(fields: [orderGroupId], references: [id])

    // Relations
    buyer    User?     @relation(fields: [buyerId], references: [id])
    merchant Merchant? @relation(fields: [merchantId], references: [id])
}

// ============================================
// SECTION 7: LOGISTICS & SHIPPING
// ============================================

// --- Enums for Logistics ---

enum AUTH_TYPE {
    API_KEY
    OAUTH
    BASIC
    JWT
}

enum DELIVERY_TYPE {
    STANDARD
    EXPRESS
    SAME_DAY
    NEXT_DAY
    SCHEDULED
    HYPERLOCAL
    INTERNATIONAL
    REVERSE
}

enum TRANSPORT_MODE {
    AIR
    SURFACE
    HYPERLOCAL
    INTERNATIONAL
}

enum SHIPPING_SOURCE {
    ORDER
    LOGISTICS
}

enum DELIVERY_STATUS {
    PENDING
    SHIPPED
    OUT_FOR_DELIVERY
    DELIVERED
    RETURNED
    FAILED
}

enum LOGISTICS_STATUS {
    CREATED
    QUOTE_SELECTED
    SHIPMENT_REGISTERED
    LABEL_GENERATED
    PICKUP_SCHEDULED
    PICKED_UP
    IN_TRANSIT
    HUB_TRANSFER
    OUT_FOR_DELIVERY
    DELIVERED
    DELIVERY_FAILED
    RETURN_REQUESTED
    RETURN_IN_TRANSIT
    RETURNED
    CANCELLED
}

enum DOCUMENT_TYPE {
    LABEL // Shipping label with barcode
    INVOICE // Tax invoice
    PICKLIST // Warehouse picking list
    MANIFEST // Bulk handover manifest
    POD // Proof of Delivery (signed by customer)
    PACKING_SLIP // Packing slip (goes inside package)
    RETURN_LABEL // Return label (for returns)
}

enum BULK_JOB_STATUS {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
    PARTIALLY_COMPLETED
}

enum MANIFEST_STATUS {
    DRAFT
    GENERATED
    HANDED_OVER
    CLOSED
}

enum NDR_STATUS {
    REPORTED // NDR reported by courier
    CUSTOMER_CONTACTED // Merchant contacted customer
    REATTEMPT_SCHEDULED // Reattempt scheduled
    RESOLVED // Customer received delivery
    RTO_INITIATED // Converting to RTO
}

// --- Courier Partner Models ---

model Address {
    id         String @id
    merchantId String

    label     String?
    name      String?
    phone     String?
    email     String?
    line1     String
    line2     String?
    landmark  String?
    city      String
    state     String
    pincode   String
    country   String  @default("India")
    latitude  Float?
    longitude Float?
    metadata  Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    merchant                Merchant                     @relation(fields: [merchantId], references: [id])
    merchantPickupAddresses MerchantStorePickupAddress[]
    merchantDefaultPrefs    MerchantPreferences[]        @relation("MerchantDefaultPickup")
    storeCustomPickupPrefs  MerchantStorePreferences[]   @relation("StoreCustomPickup")
    manifestPickups         Manifest[]

    @@index([merchantId])
}

model PackageProfile {
    id         String @id
    merchantId String

    label       String // "Small Box", "Standard", "Large Package"
    lengthCm    Float
    widthCm     Float
    heightCm    Float
    weightGrams Int

    // Optional fields
    description String?
    isReusable  Boolean @default(true)
    metadata    Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    merchant                     Merchant                      @relation(fields: [merchantId], references: [id])
    merchantStorePackageProfiles MerchantStorePackageProfile[]
    merchantDefaultPrefs         MerchantPreferences[]         @relation("MerchantDefaultPackage")
    storeCustomPackagePrefs      MerchantStorePreferences[]    @relation("StoreCustomPackage")

    @@index([merchantId])
}

model CourierPartner {
    id         String @id
    name       String
    code       String @unique
    apiBaseUrl String

    authType         AUTH_TYPE @default(API_KEY)
    credentialSource Json

    headers          Json?
    tokenConfig      Json?
    supportsCOD      Boolean @default(true)
    supportsTracking Boolean @default(true)
    webhookUrl       String?

    isActive Boolean @default(true)
    isGlobal Boolean @default(true) // üî• NEW: Admin-added global partners

    imageUrl       String?
    customMappings Json?
    serviceRegions Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    courierServices CourierService[]
    courierQuotes   CourierQuote[]
}

model CourierService {
    id               String         @id
    courierPartnerId String
    name             String
    externalCode     String
    mode             TRANSPORT_MODE
    deliveryType     DELIVERY_TYPE
    serviceLevel     String

    isActive              Boolean @default(true)
    isGlobal              Boolean @default(true) // üî• NEW: Admin-added global services
    estimatedDeliveryDays Int?
    maxCodAmount          Float?
    minWeight             Float?
    maxWeight             Float?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    courierPartner            CourierPartner               @relation(fields: [courierPartnerId], references: [id])
    courierQuotes             CourierQuote[]
    merchantEnabledServices   MerchantCourierConfig[] // Merchant enables these
    storeEnabledServices      MerchantStoreCourierConfig[] // Store overrides
    PickupSlot                PickupSlot[]
    CourierPerformanceMetrics CourierPerformanceMetrics[]
    Manifest                  Manifest[]
}

model MerchantCourierConfig {
    id               String  @id
    merchantId       String
    courierServiceId String
    isEnabled        Boolean @default(true)
    labelOverride    String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    merchant       Merchant       @relation(fields: [merchantId], references: [id])
    courierService CourierService @relation(fields: [courierServiceId], references: [id])

    @@unique([merchantId, courierServiceId]) // üî• NEW: One config per service per merchant
}

model MerchantStoreCourierConfig {
    id               String  @id
    storeId          String
    courierServiceId String
    isEnabled        Boolean @default(true)
    labelOverride    String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    store          MerchantStore  @relation(fields: [storeId], references: [id])
    courierService CourierService @relation(fields: [courierServiceId], references: [id])

    @@unique([storeId, courierServiceId]) // üî• NEW: One config per service per store
}

// --- Logistics Models ---

model Logistics {
    id              String  @id
    customerId      String?
    packageDetails  Json
    pickupAddress   Json
    dropoffAddress  Json
    estimatedCharge Float

    deliverySlaDays  Int?
    isReturnFlow     Boolean @default(false)
    merchantOverride Json?

    status LOGISTICS_STATUS @default(CREATED)

    currentLocation Json?
    lastUpdatedAt   DateTime?

    quoteFetchStatus Json?

    // ===== AUTO-ASSIGNMENT (NEW) ===== //
    autoAssigned       Boolean   @default(false)
    assignmentStrategy String? // "CHEAPEST", "FASTEST", "PREFERRED", "MANUAL"
    autoAssignedAt     DateTime?
    autoAssignReason   String? // Why this courier was selected

    // Bulk job tracking
    bulkJobId String?
    bulkJob   BulkLogisticsJob? @relation(fields: [bulkJobId], references: [id])

    // ===== PICKUP SCHEDULING (NEW) ===== //
    preferredPickupDate DateTime?
    preferredPickupTime String? // "10:00-12:00", "14:00-16:00", "ANYTIME"
    pickupScheduledAt   DateTime?
    pickupConfirmedAt   DateTime?
    pickupInstructions  String? // Special instructions for pickup

    // ===== EXISTING FIELDS ===== //
    selectedCourierId String?       @unique
    selectedCourier   CourierQuote? @relation("SelectedCourier", fields: [selectedCourierId], references: [id])
    orderId           String?       @unique
    order             ShopOrder?    @relation(fields: [orderId], references: [id])
    createdAt         DateTime      @default(now())
    updatedAt         DateTime      @updatedAt

    // Relations
    customer  User?          @relation(fields: [customerId], references: [id])
    quotes    CourierQuote[]
    shippings Shipping[]     @relation("logisticsToShipping")
}

model BulkLogisticsJob {
    id         String  @id
    merchantId String
    storeId    String?
    createdBy  String // Admin/Merchant user ID

    // Job details
    totalOrders      Int
    processedOrders  Int @default(0)
    successfulOrders Int @default(0)
    failedOrders     Int @default(0)

    status BULK_JOB_STATUS @default(PENDING)

    // Assignment strategy
    courierServiceId  String? // If specific courier selected
    autoSelect        Boolean @default(false) // Auto-select best quote
    selectionStrategy String? // "CHEAPEST", "FASTEST", "PREFERRED"

    // Filters applied
    filters Json? // { "paymentType": "COD", "city": "Mumbai", etc. }

    // Results
    orderIds String[] // Array of order IDs
    results  Json? // Detailed results per order
    errorLog Json? // Errors encountered

    startedAt   DateTime?
    completedAt DateTime?
    createdAt   DateTime  @default(now())

    // Relations
    merchant  Merchant       @relation(fields: [merchantId], references: [id])
    store     MerchantStore? @relation(fields: [storeId], references: [id])
    Logistics Logistics[]
}

model PickupSlot {
    id               String @id
    courierServiceId String

    // Slot details
    dayOfWeek String? // "MONDAY", "TUESDAY", "ANY"
    startTime String // "10:00"
    endTime   String // "12:00"
    slotLabel String // "Morning Slot", "Evening Slot"

    isActive         Boolean @default(true)
    maxPickupsPerDay Int? // Courier capacity limit

    // Relations
    courierService CourierService @relation(fields: [courierServiceId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model CourierQuote {
    id                    String         @id
    logisticsId           String
    courierCode           String
    courierName           String
    serviceName           String
    deliveryType          DELIVERY_TYPE?
    serviceLevel          String?
    shippingCharge        Float
    currency              String         @default("INR")
    estimatedDeliveryDays Int?
    estimatedPickupDate   DateTime?
    validTill             DateTime?

    // ===== ADD THESE FIELDS ===== //
    fetchedAt   DateTime  @default(now())
    cacheExpiry DateTime? // fetchedAt + cache duration
    fetchStatus String? // "success" or "failed"
    errorReason String? // Error message if failed

    // ===== EXISTING FIELDS (keep as is) ===== //
    pickupTimeWindow     Json?
    expectedDeliveryDate String?
    expectedPODDate      String?
    originCity           String?
    destinationCity      String?
    originRegion         String?
    destinationRegion    String?
    serviceCenter        String?
    areaCode             String?
    zone                 String?
    mode                 String?
    additionalDays       Int?
    apexAdditionalDays   Int?
    groundAdditionalDays Int?
    edlMessage           Boolean?
    transitErrorMessage  String?
    actualWeight         Float?
    volumetricWeight     Float?
    chargeableWeight     Float?
    chargedBy            String?
    baseRate             Float?
    fuelSurcharge        Float?
    codCharge            Float?
    totalCharge          Float?
    codSupported         Boolean  @default(true)
    trackingSupport      Boolean  @default(true)
    labelOverride        String?
    rating               Float?
    courierPartnerId     String?
    courierServiceId     String?
    createdAt            DateTime @default(now())
    updatedAt            DateTime @updatedAt

    // Relations
    logistics      Logistics       @relation(fields: [logisticsId], references: [id])
    selectedBy     Logistics?      @relation("SelectedCourier")
    CourierPartner CourierPartner? @relation(fields: [courierPartnerId], references: [id])
    CourierService CourierService? @relation(fields: [courierServiceId], references: [id])
    Shipping       Shipping[]

    @@index([logisticsId])
}

model CourierPerformanceMetrics {
    id               String  @id
    courierServiceId String
    merchantId       String? // null = platform-wide metrics
    storeId          String? // null = merchant-wide metrics
    region           String? // "Mumbai", "Delhi", "PAN India"

    // Time period
    periodStart DateTime
    periodEnd   DateTime

    // Performance data
    totalShipments        Int
    successfulDeliveries  Int
    failedDeliveries      Int
    rtoCount              Int
    avgDeliveryDays       Float
    onTimeDeliveryPercent Float

    // Financial
    totalShippingCost Float
    avgShippingCost   Float
    totalRTOCharges   Float

    // Calculated
    successRate Float // successfulDeliveries / totalShipments
    rtoRate     Float // rtoCount / totalShipments

    calculatedAt DateTime @default(now())

    // Relations
    courierService CourierService @relation(fields: [courierServiceId], references: [id])
    merchant       Merchant?      @relation(fields: [merchantId], references: [id])
    store          MerchantStore? @relation(fields: [storeId], references: [id])

    @@unique([courierServiceId, merchantId, storeId, region, periodStart])
}

// --- Shipping Models ---

model Shipping {
    id                     String  @id
    logisticsId            String?
    selectedCourierQuoteId String?

    trackingId     String?         @unique
    shippingSource SHIPPING_SOURCE @default(ORDER)

    deliveryAddress      Json
    deliveryInstructions String?

    expectedDeliveryDate DateTime?

    weight        Float?
    weightUnit    String? @default("kg")
    length        Float?
    width         Float?
    height        Float?
    dimensionUnit String? @default("cm")

    codAmount Float?

    status       DELIVERY_STATUS @default(PENDING)
    shippedAt    DateTime?
    deliveredAt  DateTime?
    returnedAt   DateTime?
    returnReason String?

    attemptCount   Int              @default(0)
    ndrReason      String?
    rtoInitiatedAt DateTime?
    trackingUrl    String?
    trackingStatus DELIVERY_STATUS?

    // ===== RTO TRACKING (NEW) ===== //
    isRTO                   Boolean   @default(false)
    rtoReason               String? // "Customer refused", "Wrong address", etc.
    rtoStatus               String? // "INITIATED", "IN_TRANSIT", "DELIVERED_TO_ORIGIN"
    rtoCompletedAt          DateTime?
    rtoCharges              Float? // Charges for RTO
    rtoChargesPaidBy        String? // "MERCHANT", "CUSTOMER", "WAIVED"
    rtoDeductedFromMerchant Boolean   @default(false)
    rtoDeductionId          String? // Link to MerchantDeduction record

    orderId String    @unique
    order   ShopOrder @relation(fields: [orderId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    logistics            Logistics?             @relation(name: "logisticsToShipping", fields: [logisticsId], references: [id])
    selectedCourierQuote CourierQuote?          @relation(fields: [selectedCourierQuoteId], references: [id])
    verifications        DeliveryVerification[]
    ShippingDocument     ShippingDocument[]
    TrackingEvent        TrackingEvent[]
    NDRAttempt           NDRAttempt[]
    ManifestShipment     ManifestShipment[]

    @@index([logisticsId])
    @@index([trackingId])
    @@index([selectedCourierQuoteId])
}

model DeliveryVerification {
    id         String    @id
    shippingId String
    otp        String
    verified   Boolean   @default(false)
    verifiedAt DateTime?
    verifiedBy String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    shipping Shipping @relation(fields: [shippingId], references: [id])

    @@index([shippingId])
}

model ShippingDocument {
    id          String        @id
    shippingId  String
    type        DOCUMENT_TYPE
    url         String
    generatedAt DateTime      @default(now())

    version  Int   @default(1)
    metadata Json?

    // Relations
    shipping Shipping @relation(fields: [shippingId], references: [id])
}

model TrackingEvent {
    id         String          @id
    shippingId String
    status     DELIVERY_STATUS
    timestamp  DateTime
    location   String?
    remarks    String?

    eventCode String?
    actor     String?

    // Relations
    shipping Shipping @relation(fields: [shippingId], references: [id])
}

model NDRAttempt {
    id            String @id
    shippingId    String
    attemptNumber Int    @default(1) // 1st, 2nd, 3rd attempt

    // NDR Details
    ndrDate        DateTime @default(now())
    ndrReason      String // "Customer not available", "Wrong address"
    ndrReasonCode  String? // Courier's internal code
    courierRemarks String?

    status NDR_STATUS @default(REPORTED)

    // Customer Response
    customerContacted   Boolean   @default(false)
    customerContactedAt DateTime?
    customerResponse    Json? // { action: "REDELIVER", preferredTime: "..." }

    // Reattempt
    reattemptScheduledAt DateTime?
    reattemptDate        DateTime?
    reattemptTimeSlot    String? // "10:00-12:00"
    reattemptAddress     Json? // If customer wants delivery elsewhere

    // Resolution
    resolvedAt     DateTime?
    resolutionType String? // "DELIVERED", "RTO", "CANCELLED"

    // Relations
    shipping Shipping @relation(fields: [shippingId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([shippingId, attemptNumber])
}

model Manifest {
    id               String  @id
    manifestNumber   String  @unique // MAN-20250118-001
    merchantId       String
    storeId          String?
    courierServiceId String

    pickupDate      DateTime
    pickupTime      String?
    pickupAddressId String

    totalShipments Int
    totalWeight    Float
    totalCODAmount Float?

    status MANIFEST_STATUS @default(DRAFT)

    // Document
    manifestUrl String? // PDF URL
    generatedAt DateTime?

    // Handover tracking
    handedOverAt     DateTime?
    handedOverBy     String? // Merchant employee name
    receivedBy       String? // Courier person name
    courierSignature String? // Image/signature URL

    // Relations
    merchant       Merchant           @relation(fields: [merchantId], references: [id])
    store          MerchantStore?     @relation(fields: [storeId], references: [id])
    courierService CourierService     @relation(fields: [courierServiceId], references: [id])
    pickupAddress  Address            @relation(fields: [pickupAddressId], references: [id])
    shipments      ManifestShipment[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([manifestNumber])
    @@index([merchantId, pickupDate])
}

model ManifestShipment {
    id         String @id
    manifestId String
    shippingId String

    waybillNumber String
    orderNumber   String
    weight        Float
    codAmount     Float?

    manifest Manifest @relation(fields: [manifestId], references: [id])
    shipping Shipping @relation(fields: [shippingId], references: [id])

    @@unique([manifestId, shippingId])
}

// ============================================
// SECTION 8: RETURNS MANAGEMENT
// ============================================

// --- Enums for Returns ---

enum RETURN_REASON {
    DAMAGED
    WRONG_ITEM
    NO_LONGER_NEEDED
    OTHER
}

enum RETURN_STATUS {
    REQUESTED
    APPROVED
    PICKED_UP
    REFUNDED
    REJECTED
}

// --- Return Models ---

model ReturnRequest {
    id                String        @id
    orderId           String
    itemId            String
    reason            RETURN_REASON
    status            RETURN_STATUS @default(REQUESTED)
    refundAmount      Float?
    exchangeVariantId String?

    pickupScheduledAt DateTime?
    pickupCourierCode String?
    refundSynced      Boolean   @default(false)

    // Relations
    order ShopOrder     @relation(fields: [orderId], references: [id])
    item  ShopOrderItem @relation(fields: [itemId], references: [id])
}

// ============================================
// SECTION 9: COMMUNICATION SYSTEM
// ============================================

// --- Enums for Communication ---

enum CONVERSATION_TYPE {
    CUSTOM
    LISTING
    ORDER
    DISPUTE
}

enum CONVERSATION_STATUS {
    ACTIVE
    FINISHED
    BLOCKED
}

enum PARTICIPANT_TYPE {
    BUYER
    SELLER
    MERCHANT
    ADMIN
    GUEST
}

// --- Communication Models ---

model Notification {
    id        String  @id
    userId    String
    title     String
    message   String
    type      String
    event     String
    link      String?
    data      Json?
    priority  Int     @default(1)
    delivered Boolean @default(false)
    read      Boolean @default(false)

    createdAt DateTime @default(now())

    // Relations
    user User @relation(fields: [userId], references: [id])

    @@index([userId])
    @@index([type])
    @@index([event])
}

model Conversation {
    id      String  @id
    orderId String?
    order   Order?  @relation(fields: [orderId], references: [id])

    disputeId String?        @unique
    dispute   DisputeTicket? @relation(fields: [disputeId], references: [id])

    listingId String?
    Listing   Listing? @relation(fields: [listingId], references: [id])

    type   CONVERSATION_TYPE
    status CONVERSATION_STATUS @default(ACTIVE)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    participants ConversationParticipant[]
    messages     Message[]
}

model ConversationParticipant {
    id             String       @id
    conversationId String
    conversation   Conversation @relation(fields: [conversationId], references: [id])

    participantType PARTICIPANT_TYPE
    participantId   String?
    customerInfo    Json?

    joinedAt DateTime @default(now())

    @@unique([conversationId, participantType, participantId])
}

model Message {
    id             String       @id
    conversationId String
    conversation   Conversation @relation(fields: [conversationId], references: [id])

    senderType   PARTICIPANT_TYPE
    senderId     String?
    customerInfo Json?

    content     String
    attachments Json?
    createdAt   DateTime @default(now())
}

// ============================================
// SECTION 10: DISPUTE RESOLUTION
// ============================================

// --- Enums for Disputes ---

enum DISPUTE_ROLE {
    BUYER
    SELLER
}

enum DISPUTE_STATUS {
    PENDING
    IN_PROGRESS
    RESOLVED
    REJECTED
}

enum REFUND_METHOD {
    RAZORPAY
    RAZORPAYX
    UPI
    BANK_TRANSFER
}

enum REFUND_STATUS {
    NONE
    PENDING
    APPROVED
    REJECTED
    PROCESSED
}

enum REFUND_AMOUNT_STATUS {
    NONE
    PARTIALLY_REFUNDED
    FULLY_REFUNDED
}

// --- Marketplace Dispute Models ---

model DisputeTicket {
    id      String @id
    orderId String @unique

    raisedBy DISPUTE_ROLE

    raisedById   String
    raisedByUser User   @relation(fields: [userId], references: [id])

    reason            String
    status            DISPUTE_STATUS @default(PENDING)
    resolution        String?
    createdAt         DateTime       @default(now())
    updatedAt         DateTime       @updatedAt
    resolvedAt        DateTime?
    resolvedByAdminId String?
    resolvedByAdmin   Admin?         @relation("AdminDisputes", fields: [resolvedByAdminId], references: [id])
    userId            String

    // Relations
    order        Order         @relation(fields: [orderId], references: [id])
    conversation Conversation?
    refund       Refund?
}

model Refund {
    id            String  @id
    disputeId     String? @unique
    orderId       String?
    transactionId String?

    refundedAt         DateTime?
    amount             Float
    refundMethod       REFUND_METHOD
    notes              String?
    status             REFUND_STATUS        @default(PENDING)
    refundAmountStatus REFUND_AMOUNT_STATUS @default(NONE)
    createdAt          DateTime             @default(now())
    updatedAt          DateTime             @updatedAt

    // Relations
    dispute     DisputeTicket? @relation(fields: [disputeId], references: [id])
    order       Order?         @relation(fields: [orderId], references: [id])
    transaction Transaction?   @relation(fields: [transactionId], references: [id])
}

// --- E-commerce Dispute Models ---

model ShopDisputeTicket {
    id      String @id
    orderId String @unique

    raisedBy     USER_ROLE
    raisedById   String?
    customerInfo Json?

    reason            String
    status            DISPUTE_STATUS @default(PENDING)
    resolution        String?
    createdAt         DateTime       @default(now())
    updatedAt         DateTime       @updatedAt
    resolvedAt        DateTime?
    resolvedByAdminId String?
    resolvedByAdmin   Admin?         @relation(fields: [resolvedByAdminId], references: [id])

    // Relations
    order      ShopOrder   @relation(fields: [orderId], references: [id])
    ShopRefund ShopRefund?
}

model ShopRefund {
    id            String  @id
    disputeId     String? @unique
    orderId       String?
    transactionId String?

    refundedAt         DateTime?
    amount             Float
    refundMethod       REFUND_METHOD
    notes              String?
    status             REFUND_STATUS        @default(PENDING)
    refundAmountStatus REFUND_AMOUNT_STATUS @default(NONE)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    dispute     ShopDisputeTicket? @relation(fields: [disputeId], references: [id])
    order       ShopOrder?         @relation(fields: [orderId], references: [id])
    transaction ShopTransaction?   @relation(fields: [transactionId], references: [id])
}

// ============================================
// SECTION 11: PLATFORM FEE MANAGEMENT
// ============================================

// --- Enums for Platform Fees ---

enum PLATFORM_FEE_TYPE {
    PERCENTAGE
    FIXED
}

enum FEE_CATEGORY {
    PLATFORM
    LOGISTICS
    COD
    PACKAGING
    INSURANCE
    TRANSACTION
}

enum FEE_SOURCE_LEVEL {
    PLATFORM
    MERCHANT
    STORE
}

enum FEE_SOURCE {
    GLOBAL
    MERCHANT_SPECIFIC
    SHOP
}

enum FEE_TYPE {
    PERCENTAGE
    FIXED
}

// --- Platform Fee Models ---

model PlatformFeeConfig {
    id       String            @id @default(uuid())
    category FEE_CATEGORY
    label    String
    feeType  PLATFORM_FEE_TYPE
    feeValue Float
    codFee   Float             @default(50)
    currency String            @default("INR")
    isActive Boolean           @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model MerchantPlatformFee {
    id         String   @id @default(uuid())
    merchantId String
    merchant   Merchant @relation(fields: [merchantId], references: [id])

    category FEE_CATEGORY
    label    String
    feeType  PLATFORM_FEE_TYPE
    feeValue Float
    currency String            @default("INR")
    isActive Boolean           @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model StorePlatformFee {
    id      String        @id @default(uuid())
    storeId String
    store   MerchantStore @relation(fields: [storeId], references: [id])

    category FEE_CATEGORY
    label    String
    feeType  PLATFORM_FEE_TYPE
    feeValue Float
    currency String            @default("INR")
    isActive Boolean           @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model PlatformFeeLog {
    id          String            @id @default(uuid())
    orderId     String
    merchantId  String?
    storeId     String?
    category    FEE_CATEGORY
    sourceLevel FEE_SOURCE_LEVEL
    sourceId    String?
    feeType     PLATFORM_FEE_TYPE
    feeValue    Float
    currency    String            @default("INR")
    label       String?
    appliedAt   DateTime          @default(now())

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model PlatformSetting {
    id        String     @id
    feeSource FEE_SOURCE @default(GLOBAL)
    feeType   FEE_TYPE   @default(PERCENTAGE)
    feeValue  Float      @default(10)
    updatedAt DateTime   @updatedAt
}

// ============================================
// END OF SCHEMA
// ============================================

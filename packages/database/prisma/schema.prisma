// ============================================
// PRISMA CONFIGURATION
// ============================================

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ============================================
// GLOBAL ENUMS
// ============================================

// User & Authentication
enum USER_TYPE {
    BUYER
    SELLER
}

enum USER_STATUS {
    ACTIVE
    BANNED
}

enum USER_VERIFICATION_STATUS {
    DEFAULT
    APPROVED
    PENDING
    REJECTED
}

enum USER_ROLE {
    BUYER
    SELLER
    MERCHANT
    ADMIN
    GUEST
}

enum ADMIN_STATUS {
    ACTIVE
    INACTIVE
}

// Merchant & Store
enum MERCHANT_MODE {
    TEST
    LIVE
}

enum STORE_TYPE {
    SHOPIFY
    WOOCOMMERCE
}

enum STORE_CONNECTION_TYPE {
    OAUTH
    MANUAL
}

enum STORE_STATUS {
    ACTIVE
    INACTIVE
    BLOCKED
}

enum ONBOARDING_STATUS {
    PENDING
    SKIPPED
    COMPLETED
}

enum API_STATUS {
    ENABLED
    DISABLED
    REVOKED
}

enum PLAN_TYPE {
    FREE
    STARTER
    PROFESSIONAL
    ENTERPRISE
    CUSTOM
}

enum SUBSCRIPTION_STATUS {
    ACTIVE
    TRIAL
    CANCELLED
    PAST_DUE
    EXPIRED
}

// Financial & Account
enum ACCOUNT_STATUS {
    ACTIVE
    SUSPENDED
    CLOSED
}

enum PAYOUT_STATUS {
    PENDING
    SUCCESS
    FAILED
    CANCELLED
}

enum PAYOUT_METHOD {
    UPI
    BANK_TRANSFER
    RAZORPAY
}

enum PAYOUT_FREQUENCY {
    MANUAL
    WEEKLY
    MONTHLY
}

enum DEDUCTION_TYPE {
    SHIPPING
    REVERSE_DELIVERY
    COD_CHARGE
    PENALTY
    PLATFORM_FEE
    DISPUTE_RESOLUTION
    MANUAL_ADJUSTMENT
}

enum DEDUCTION_STATUS {
    PENDING
    SETTLED
    WAIVED
}

enum DEDUCTION_SOURCE {
    SYSTEM
    ADMIN
    MERCHANT
}

// Marketplace
enum LISTING_TYPE {
    PRODUCT
    SERVICE
}

enum LISTING_STATUS {
    ACTIVE
    INACTIVE
    BLOCKED
}

enum CONNECT_STATUS {
    PENDING
    ACCEPTED
    REJECTED
    CLOSED
}

enum ORDER_TYPE {
    CUSTOM
    PRODUCT
    SERVICE
}

enum ORDER_FLOW_STATUS {
    PENDING
    APPROVED
    REJECTED
}

enum PLATFORM_FEE_PAYER {
    BUYER
    SELLER
    BOTH
}

enum CHARGE_PAYER {
    BUYER
    SELLER
}

enum MARKETPLACE_ORDER_STATUS {
    PENDING
    CREATED
    PAID
    ON_HOLD
    FINISHED
    ON_DISPUTE
    RELEASED
    REFUNDED
    CANCELLED
}

// E-commerce Orders
enum SHOP_ORDER_SOURCE {
    SHOPIFY
    RAKSHASETU
    WOOCOMMERCE
}

enum ORDER_STATUS {
    CREATED
    PAYMENT_PENDING
    PAYMENT_RECEIVED
    READY_FOR_PICKUP
    PICKED_UP
    IN_TRANSIT
    OUT_FOR_DELIVERY
    DELIVERED
    RETURN_REQUESTED
    RETURN_IN_TRANSIT
    RETURNED
    CANCELLED
    FAILED_DELIVERY
    DISPUTE_OPEN
    DISPUTE_RESOLVED
    REFUND_INITIATED
    REFUND_COMPLETED
}

enum FULFILLMENT_STATUS {
    UNFULFILLED
    PARTIALLY_FULFILLED
    FULFILLED
    CANCELLED
}

enum ORDER_GROUP_SOURCE {
    RAKSHASETU
    SHOPIFY
    WOOCOMMERCE
    MANUAL
}

enum ORDER_GROUP_STATUS {
    PENDING
    PARTIALLY_FULFILLED
    FULFILLED
    CANCELLED
    DISPUTED
}

enum ORDER_GROUP_TYPE {
    MARKETPLACE
    SINGLE_STORE
    BULK_IMPORT
}

// Payment & Transaction
enum PAYMENT_METHOD {
    PREPAID
    POD
    COD
}

enum PAYMENT_STATUS {
    INITIATED
    AUTHORIZED
    CAPTURED
    FAILED
    REFUNDED
    PARTIALLY_REFUNDED
    COD_PENDING
    COD_COLLECTED
    COD_FAILED
}

enum PAYMENT_ORDER_SOURCE {
    CHECKOUT
    API
    MARKETPLACE
    SHOP
}

enum TRANSACTION_STATUS {
    INITIATED
    ON_HOLD
    AWAITING_RELEASE
    RELEASED_TO_SELLER
    REFUND_PENDING
    REFUNDED_TO_BUYER
    DISPUTED
    CANCELLED
    FAILED
}

enum ESCROW_STATUS {
    INITIATED
    HELD
    RELEASE_REQUESTED
    RELEASED
    DISPUTE_OPEN
    DISPUTE_RESOLVED
    REFUNDED
}

enum SHOP_PLATFORM_FEE_PAYER {
    MERCHANT
    CUSTOMER
}

// Logistics & Shipping
enum AUTH_TYPE {
    API_KEY
    OAUTH
    BASIC
    JWT
}

enum DELIVERY_TYPE {
    STANDARD
    EXPRESS
    SAME_DAY
    NEXT_DAY
    SCHEDULED
    HYPERLOCAL
    INTERNATIONAL
    REVERSE
}

enum TRANSPORT_MODE {
    AIR
    SURFACE
    HYPERLOCAL
    INTERNATIONAL
}

enum SHIPPING_SOURCE {
    ORDER
    LOGISTICS
}

enum DELIVERY_STATUS {
    PENDING
    SHIPPED
    OUT_FOR_DELIVERY
    DELIVERED
    RETURNED
    FAILED
}

enum LOGISTICS_STATUS {
    CREATED
    QUOTE_SELECTED
    SHIPMENT_REGISTERED
    LABEL_GENERATED
    PICKUP_SCHEDULED
    PICKED_UP
    IN_TRANSIT
    HUB_TRANSFER
    OUT_FOR_DELIVERY
    DELIVERED
    DELIVERY_FAILED
    RETURN_REQUESTED
    RETURN_IN_TRANSIT
    RETURNED
    CANCELLED
}

enum DOCUMENT_TYPE {
    LABEL
    INVOICE
    PICKLIST
    MANIFEST
    POD
    PACKING_SLIP
    RETURN_LABEL
}

enum BULK_JOB_STATUS {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
    PARTIALLY_COMPLETED
}

enum MANIFEST_STATUS {
    DRAFT
    GENERATED
    HANDED_OVER
    CLOSED
}

enum NDR_STATUS {
    REPORTED
    CUSTOMER_CONTACTED
    REATTEMPT_SCHEDULED
    RESOLVED
    RTO_INITIATED
}

// Returns & Disputes
enum RETURN_REASON {
    DAMAGED
    WRONG_ITEM
    NO_LONGER_NEEDED
    OTHER
}

enum RETURN_STATUS {
    REQUESTED
    APPROVED
    PICKED_UP
    REFUNDED
    REJECTED
}

enum DISPUTE_ROLE {
    BUYER
    SELLER
}

enum DISPUTE_STATUS {
    PENDING
    IN_PROGRESS
    RESOLVED
    REJECTED
}

enum REFUND_METHOD {
    RAZORPAY
    RAZORPAYX
    UPI
    BANK_TRANSFER
}

enum REFUND_STATUS {
    NONE
    PENDING
    APPROVED
    REJECTED
    PROCESSED
}

enum REFUND_AMOUNT_STATUS {
    NONE
    PARTIALLY_REFUNDED
    FULLY_REFUNDED
}

// Communication
enum CONVERSATION_TYPE {
    CUSTOM
    CONNECTION
    DISPUTE
}

enum CONVERSATION_STAGE {
    LISTING
    ORDER
    DISPUTE
}

enum CONVERSATION_STATUS {
    ACTIVE
    ARCHIVED
    CLOSED
}

enum PARTICIPANT_TYPE {
    BUYER
    SELLER
    MERCHANT
    ADMIN
    GUEST
}

// Cart & Products
enum CartStatus {
    ACTIVE
    CHECKED_OUT
    ABANDONED
    EXPIRED
}

// Webhooks & Integration
enum WEBHOOK_TOPIC {
    ORDERS_CREATE
    ORDERS_UPDATE
    ORDERS_CANCELLED
    ORDERS_PAID
    PRODUCTS_CREATE
    PRODUCTS_UPDATE
    PRODUCTS_DELETE
    INVENTORY_UPDATE
    CHECKOUTS_CREATE
    CHECKOUTS_UPDATE
    APP_UNINSTALLED
    SHOP_UPDATE
    CUSTOMERS_CREATE
    CUSTOMERS_UPDATE
}

enum WEBHOOK_STATUS {
    ACTIVE
    INACTIVE
    FAILED
}

enum NotificationEvent {
    PAYMENT_SUCCESS
    PAYMENT_FAILED
    ORDER_CREATED
    ORDER_DISPUTE
    REFUND_PROCESSED
}

// Sync & Session
enum SYNC_STATUS {
    IDLE
    SYNCING
    ERROR
    COMPLETED
}

enum SESSION_STATUS {
    ACTIVE
    COMPLETED
    ABANDONED
    EXPIRED
}

enum SYNC_TYPE {
    PRODUCTS
    ORDERS
    INVENTORY
    CUSTOMERS
    WEBHOOKS
    FULL_SYNC
}

enum SYNC_RESULT {
    SUCCESS
    PARTIAL
    FAILED
}

// Platform Fees & Settings
enum PLATFORM_FEE_TYPE {
    PERCENTAGE
    FIXED
}

enum FEE_CATEGORY {
    PLATFORM
    LOGISTICS
    COD
    PACKAGING
    INSURANCE
    TRANSACTION
}

enum FEE_SOURCE_LEVEL {
    PLATFORM
    MERCHANT
    STORE
}

enum FEE_SOURCE {
    GLOBAL
    MERCHANT_SPECIFIC
    SHOP
}

enum FEE_TYPE {
    PERCENTAGE
    FIXED
}

enum REMITTANCE_CYCLE {
    DAILY
    WEEKLY
    ON_DELIVERY
}

// ============================================
// SECTION 1: USER & AUTHENTICATION MANAGEMENT
// ============================================

model User {
    id                  String                   @id
    firstName           String
    lastName            String
    userName            String                   @unique
    email               String                   @unique
    business            String
    type                USER_TYPE                @default(BUYER)
    mobile              String
    password            String
    image               String?
    status              USER_STATUS              @default(ACTIVE)
    address             Json?
    emailVerified       Boolean                  @default(false)
    smsVerified         Boolean                  @default(false)
    kycVerified         USER_VERIFICATION_STATUS @default(DEFAULT)
    bankVerified        USER_VERIFICATION_STATUS @default(DEFAULT)
    gstVerified         USER_VERIFICATION_STATUS @default(DEFAULT)
    verificationCode    String?
    verificationSentAt  DateTime?
    twoFactorVerified   Boolean                  @default(false)
    twoFactorSecret     String?
    twoFactorQrCode     String?
    twoFactorStatus     Boolean                  @default(false)
    deviceId            String?
    emailVerifiedAt     DateTime?
    rememberToken       String?
    refreshToken        String?
    refreshTokenExpires DateTime?
    hasSoldBefore       Boolean                  @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    UserKycDetails   UserKycDetails?
    SellerAccount    SellerAccount?
    notifications    Notification[]
    listings         Listing[]
    userConnects     Connects[]       @relation("user")
    sellerConnects   Connects[]       @relation("seller")
    ordersBought     Order[]          @relation("order_buyer")
    ordersSold       Order[]          @relation("order_seller")
    PaymentsAsBuyer  Payment[]        @relation("PaymentBuyer")
    PaymentsAsSeller Payment[]        @relation("PaymentSeller")
    DisputeTicket    DisputeTicket[]
    Logistics        Logistics[]
    ShopCart         ShopCart[]
    ShopOrderGroup   ShopOrderGroup[]
    ShopPayment      ShopPayment[]

    @@map("users")
}

model UserKycDetails {
    id     String  @id
    userId String? @unique

    // PAN Details
    panNumber             String?
    dateOfBirth           String?
    fullNameAsPerPan      String?
    panVerificationStatus USER_VERIFICATION_STATUS @default(DEFAULT)
    panRejectionReason    String?

    // Aadhaar Details
    aadharNumber             String?
    fullNameAsPerAadhar      String?
    aadhaarReferenceId       String?
    aadharVerificationStatus USER_VERIFICATION_STATUS @default(DEFAULT)
    aadharRejectionReason    String?

    // GST Details
    gstNumber             String?
    gstStatus             String?
    constitution          String?
    registrationDate      String?
    businessName          String?
    businessAddress       Json?
    tradeName             String?
    gstVerificationStatus USER_VERIFICATION_STATUS @default(DEFAULT)
    gstRejectionReason    String?

    // Bank Details
    bankAccountNumber      String?
    bankIfscCode           String?
    fullNameAsPerBank      String?
    bankVerificationStatus USER_VERIFICATION_STATUS @default(DEFAULT)
    bankRejectionReason    String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("user_kyc_details")
}

model Admin {
    id        String       @id
    firstName String
    lastName  String
    userName  String       @unique
    email     String       @unique
    password  String
    image     String?
    status    ADMIN_STATUS @default(ACTIVE)

    emailVerified       Boolean   @default(false)
    emailVerifiedAt     DateTime?
    verificationCode    String?
    verificationSentAt  DateTime?
    refreshToken        String?
    refreshTokenExpires DateTime?

    roleId String
    role   AdminRole @relation(fields: [roleId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    DisputeTickets    DisputeTicket[]     @relation("AdminDisputes")
    ShopDisputeTicket ShopDisputeTicket[]

    @@map("admins")
}

model AdminRole {
    id          String  @id
    name        String  @unique
    description String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    admins      Admin[]
    permissions AdminPermission[] @relation("RolePermissions")

    @@map("admin_roles")
}

model AdminPermission {
    id    String  @id
    name  String  @unique
    label String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    roles AdminRole[] @relation("RolePermissions")

    @@map("admin_permissions")
}

// ============================================
// SECTION 2: MERCHANT & STORE MANAGEMENT
// ============================================

model Merchant {
    id           String @id
    businessName String
    email        String @unique
    phone        String

    // Dashboard Authentication
    password            String?
    emailVerified       Boolean   @default(false)
    emailVerifiedAt     DateTime?
    refreshToken        String?
    refreshTokenExpires DateTime?

    // Status & Mode
    status      String    @default("ACTIVE")
    isActive    Boolean   @default(true)
    mode        String    @default("TEST")
    image       String?
    lastLoginAt DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Core Relations
    profile       MerchantProfile?
    notifications MerchantNotifications?
    account       MerchantAccount?
    logistics     MerchantLogistics?
    preferences   MerchantPreferences?

    // Infrastructure
    stores          MerchantStore[]
    addresses       Address[]
    packageProfiles PackageProfile[]
    courierConfigs  MerchantCourierConfig[]

    // Financial
    deductions   MerchantDeduction[]
    platformFees MerchantPlatformFee[]

    // Operations
    products           ShopProduct[]
    orders             ShopOrder[]
    payments           ShopPayment[]
    bulkJobs           BulkLogisticsJob[]
    manifests          Manifest[]
    performanceMetrics CourierPerformanceMetrics[]

    // Integration
    apiKeys       MerchantApiKey[]
    webhooks      MerchantWebhook[]
    shopifyStates ShopifyState[]

    @@index([email])
    @@index([status])
    @@map("merchants")
}

model MerchantProfile {
    id         String   @id
    merchantId String   @unique
    merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    // Business Details
    businessType String?
    gstNumber    String?
    panNumber    String?
    aadharNumber String?

    // Bank Details
    bankAccount   String?
    ifscCode      String?
    accountHolder String?

    // Verification Status
    kycStatus        USER_VERIFICATION_STATUS @default(PENDING)
    gstVerified      USER_VERIFICATION_STATUS @default(PENDING)
    panVerified      USER_VERIFICATION_STATUS @default(PENDING)
    aadharVerified   USER_VERIFICATION_STATUS @default(PENDING)
    bankVerified     USER_VERIFICATION_STATUS @default(PENDING)
    onboardingStatus ONBOARDING_STATUS        @default(PENDING)

    // Documents
    kycDocuments Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("merchant_profiles")
}

model MerchantNotifications {
    id         String   @id
    merchantId String   @unique
    merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    // Order Notifications
    notifyOnNewOrder Boolean @default(true)
    notifyOnPayment  Boolean @default(true)
    notifyOnShipment Boolean @default(true)
    notifyOnDelivery Boolean @default(true)
    notifyOnReturn   Boolean @default(true)
    notifyOnDispute  Boolean @default(true)

    // Channels
    emailEnabled    Boolean @default(true)
    whatsappEnabled Boolean @default(true)
    smsEnabled      Boolean @default(false)

    // Contact Overrides
    notificationEmail    String?
    notificationWhatsApp String?
    notificationPhone    String?

    // Reports
    dailyReportEnabled  Boolean @default(false)
    weeklyReportEnabled Boolean @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("merchant_notifications")
}

model MerchantPreferences {
    id         String   @id
    merchantId String   @unique
    merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    // Default Package Profile
    defaultPackageProfileId String?
    defaultPackageProfile   PackageProfile? @relation("MerchantDefaultPackage", fields: [defaultPackageProfileId], references: [id])

    // Default Pickup Address
    defaultPickupAddressId String?
    defaultPickupAddress   Address? @relation("MerchantDefaultPickup", fields: [defaultPickupAddressId], references: [id])

    // Quote Settings
    sortQuotesBy       String @default("PRICE")
    quoteCacheDuration Int    @default(15)

    // COD Settings
    codEnabled       Boolean @default(true)
    codMinOrderValue Float?  @default(0)

    // Policies
    returnPolicy     Json?
    slaThresholdDays Int?
    remittanceCycle  REMITTANCE_CYCLE

    // Admin Controls
    allowManualOverride Boolean  @default(true)
    updatedBy           String?
    createdAt           DateTime @default(now())
    updatedAt           DateTime @updatedAt

    @@map("merchant_preferences")
}

model MerchantStore {
    id         String   @id
    merchantId String
    merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    // Store Identity
    storeType    String
    storeName    String
    storeUrl     String
    customDomain String?
    storeSlug    String? @unique
    externalId   String?

    // Connection & Auth
    connectionType String
    status         STORE_STATUS @default(ACTIVE)
    isActive       Boolean      @default(true)

    // OAuth Credentials
    apiKey      String?
    apiSecret   String?
    scopes      String?
    accessToken String?

    // Installation Tracking
    installedAt       DateTime?
    uninstalledAt     DateTime?
    lastActiveAt      DateTime  @updatedAt
    installationCount Int       @default(1)

    // Store Info
    storeInfo Json?

    // Sync Status
    syncStatus            SYNC_STATUS @default(IDLE)
    connectedAt           DateTime?
    lastProductsSyncedAt  DateTime?
    lastOrdersSyncedAt    DateTime?
    lastStoreSyncedAt     DateTime?
    lastWebhookReceivedAt DateTime?

    autoSyncProducts  Boolean @default(true)
    autoSyncOrders    Boolean @default(true)
    autoSyncInventory Boolean @default(false)
    syncInterval      Int     @default(30)

    syncErrorCount  Int       @default(0)
    lastSyncError   String?
    lastSyncErrorAt DateTime?

    // Marketplace
    showOnMarketplace Boolean @default(false)
    marketplaceListed Boolean @default(false)

    // Onboarding
    onboardingComplete Boolean @default(false)
    extensionInstalled Boolean @default(false)

    // Features & Limits
    features          Json?
    orderQuotaLimit   Int?
    orderQuotaUsed    Int       @default(0)
    orderQuotaResetAt DateTime?

    // Performance
    totalOrders       Int   @default(0)
    totalRevenue      Float @default(0)
    averageOrderValue Float @default(0)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    config        StoreConfig?
    logistics     StoreLogistics?
    subscription  StoreSubscription?
    notifications StoreNotificationSettings?
    preferences   MerchantStorePreferences?

    products           ShopProduct[]
    orders             ShopOrder[]
    webhooks           StoreWebhook[]
    sessions           StoreSession[]
    analytics          StoreAnalytics[]
    syncLogs           StoreSyncLog[]
    platformFees       StorePlatformFee[]
    bulkJobs           BulkLogisticsJob[]
    manifests          Manifest[]
    performanceMetrics CourierPerformanceMetrics[]
    pickupAddresses    MerchantStorePickupAddress[]
    packageProfiles    MerchantStorePackageProfile[]
    courierConfigs     MerchantStoreCourierConfig[]

    @@unique([merchantId, storeUrl])
    @@index([merchantId])
    @@index([storeUrl])
    @@index([storeSlug])
    @@index([status])
    @@map("merchant_stores")
}

model MerchantStorePreferences {
    id      String        @id
    storeId String        @unique
    store   MerchantStore @relation(fields: [storeId], references: [id], onDelete: Cascade)

    // Override Control
    overrideMerchantPrefs Boolean @default(false)

    // Package Settings
    useCustomPackageProfile Boolean         @default(false)
    customPackageProfileId  String?
    customPackageProfile    PackageProfile? @relation("StoreCustomPackage", fields: [customPackageProfileId], references: [id])

    // Pickup Address Settings
    useCustomPickupAddress Boolean  @default(false)
    customPickupAddressId  String?
    customPickupAddress    Address? @relation("StoreCustomPickup", fields: [customPickupAddressId], references: [id])

    // Quote Settings
    sortQuotesBy       String?
    quoteCacheDuration Int?

    // COD Settings
    codEnabled       Boolean?
    codMinOrderValue Float?

    // Other Settings
    slaThresholdDays Int?
    returnPolicy     Json?
    remittanceCycle  REMITTANCE_CYCLE @default(WEEKLY)

    // Admin Controls
    allowManualOverride Boolean  @default(true)
    updatedBy           String?
    createdAt           DateTime @default(now())
    updatedAt           DateTime @updatedAt

    @@map("merchant_store_preferences")
}

model StoreConfig {
    id      String        @id
    storeId String        @unique
    store   MerchantStore @relation(fields: [storeId], references: [id], onDelete: Cascade)

    // Pricing Overrides
    codFee     Float?
    podFee     Float?
    prepaidFee Float?
    partialFee Float?

    // Notifications
    notifyOnNewOrder Boolean?
    notifyOnShipment Boolean?

    // UI Customization
    customLogo   String?
    primaryColor String?

    // Extra Settings
    extraSettings Json? @default("{}")

    updatedAt DateTime @updatedAt

    @@map("store_configs")
}

model StoreLogistics {
    id      String        @id
    storeId String        @unique
    store   MerchantStore @relation(fields: [storeId], references: [id], onDelete: Cascade)

    // Override Control
    useCustomSettings Boolean @default(false)

    // Address Overrides
    customPickupAddressId String?
    customPickupAddress   Address? @relation("StorePickupLogistics", fields: [customPickupAddressId], references: [id])

    customReturnAddressId String?
    customReturnAddress   Address? @relation("StoreReturnLogistics", fields: [customReturnAddressId], references: [id])

    // Package Override
    customPackageProfileId String?
    customPackageProfile   PackageProfile? @relation("StorePackageLogistics", fields: [customPackageProfileId], references: [id])

    // Courier Override
    customDefaultCourier String?

    // COD Override
    customCodEnabled       Boolean?
    customCodMinOrderValue Float?

    // Return Policy Override
    customReturnWindowDays     Int?
    customReturnShippingPaidBy String?
    customExchangesEnabled     Boolean?
    customExchangeWindowDays   Int?

    updatedAt DateTime @updatedAt

    @@map("store_logistics")
}

model StoreNotificationSettings {
    id      String        @id
    storeId String        @unique
    store   MerchantStore @relation(fields: [storeId], references: [id], onDelete: Cascade)

    // Email Notifications
    emailOnNewOrder  Boolean @default(true)
    emailOnShipment  Boolean @default(true)
    emailOnDelivery  Boolean @default(true)
    emailOnReturn    Boolean @default(true)
    emailOnLowStock  Boolean @default(false)
    emailOnSyncError Boolean @default(true)

    notificationEmails String[]

    // Webhook Notifications
    webhookUrl    String?
    webhookEvents Json?

    // Integrations
    slackWebhook   String?
    discordWebhook String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("store_notification_settings")
}

model StoreSubscription {
    id      String        @id
    storeId String        @unique
    store   MerchantStore @relation(fields: [storeId], references: [id], onDelete: Cascade)

    planType        PLAN_TYPE @default(FREE)
    billingInterval String    @default("MONTHLY")
    price           Float     @default(0)
    currency        String    @default("INR")

    // Limits
    orderLimit    Int?
    featureAccess Json?

    // Billing Cycle
    currentPeriodStart DateTime
    currentPeriodEnd   DateTime
    nextBillingDate    DateTime?

    // Status
    status             SUBSCRIPTION_STATUS @default(TRIAL)
    trialEndsAt        DateTime?
    cancelledAt        DateTime?
    cancellationReason String?

    // Payment
    razorpaySubscriptionId String?
    lastPaymentAt          DateTime?
    lastPaymentAmount      Float?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([storeId])
    @@index([status])
    @@map("store_subscriptions")
}

// ============================================
// SECTION 3: INTEGRATION & SYNC MANAGEMENT
// ============================================

model MerchantApiKey {
    id         String   @id
    merchantId String
    merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    publicKey  String        @unique
    secretHash String
    scopes     String[]
    mode       MERCHANT_MODE
    status     API_STATUS

    createdAt  DateTime  @default(now())
    lastUsedAt DateTime?
    revokedAt  DateTime?

    @@index([merchantId])
    @@map("merchant_api_keys")
}

model MerchantWebhook {
    id         String   @id
    merchantId String
    merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    url    String
    events NotificationEvent[]

    createdAt DateTime @default(now())

    @@index([merchantId])
    @@map("merchant_webhooks")
}

model ShopifyState {
    id         String    @id
    merchantId String?
    merchant   Merchant? @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    shopUrl   String
    state     String   @unique
    expiresAt DateTime

    createdAt DateTime @default(now())

    @@index([merchantId])
    @@map("shopify_states")
}

model ShopifyTempSession {
    id          String    @id @default(cuid())
    shop        String    @unique
    accessToken String
    scope       String?
    expiresAt   DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("shopify_temp_sessions")
}

model ShopifyCheckoutSession {
    id              String   @id @default(cuid())
    storeDomain     String
    ownerEmail      String
    cartPayload     Json
    customerPayload Json
    createdAt       DateTime @default(now())
    expiresAt       DateTime

    @@index([storeDomain])
    @@index([ownerEmail])
    @@index([expiresAt])
    @@map("shopify_checkout_sessions")
}

model StoreWebhook {
    id      String        @id
    storeId String
    store   MerchantStore @relation(fields: [storeId], references: [id], onDelete: Cascade)

    topic     WEBHOOK_TOPIC
    webhookId String?
    address   String
    status    WEBHOOK_STATUS @default(ACTIVE)

    lastFiredAt   DateTime?
    lastSuccessAt DateTime?
    failureCount  Int       @default(0)
    lastFailureAt DateTime?
    lastError     String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([storeId, topic])
    @@index([storeId, status])
    @@map("store_webhooks")
}

model StoreSession {
    id      String        @id
    storeId String
    store   MerchantStore @relation(fields: [storeId], references: [id], onDelete: Cascade)

    sessionToken String  @unique
    cartId       String?
    checkoutId   String?
    customerId   String?

    cartData     Json?
    customerData Json?
    checkoutUrl  String?

    status SESSION_STATUS @default(ACTIVE)

    // Analytics
    ipAddress   String?
    userAgent   String?
    referrer    String?
    utmSource   String?
    utmMedium   String?
    utmCampaign String?

    startedAt   DateTime  @default(now())
    completedAt DateTime?
    abandonedAt DateTime?
    expiresAt   DateTime

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([storeId, status])
    @@index([sessionToken])
    @@index([expiresAt])
    @@map("store_sessions")
}

model StoreAnalytics {
    id      String        @id
    storeId String
    store   MerchantStore @relation(fields: [storeId], references: [id], onDelete: Cascade)
    date    DateTime

    // Orders
    totalOrders       Int   @default(0)
    completedOrders   Int   @default(0)
    cancelledOrders   Int   @default(0)
    totalRevenue      Float @default(0)
    averageOrderValue Float @default(0)

    // Checkout
    checkoutSessions    Int   @default(0)
    checkoutCompletions Int   @default(0)
    checkoutAbandonment Int   @default(0)
    conversionRate      Float @default(0)

    // Products
    totalProducts      Int @default(0)
    productsOutOfStock Int @default(0)
    productsSynced     Int @default(0)

    // Logistics
    ordersShipped   Int @default(0)
    ordersDelivered Int @default(0)
    ordersReturned  Int @default(0)

    // Webhooks
    webhooksReceived Int @default(0)
    webhooksFailed   Int @default(0)

    calculatedAt DateTime @default(now())

    @@unique([storeId, date])
    @@index([storeId])
    @@index([date])
    @@map("store_analytics")
}

model StoreSyncLog {
    id      String        @id
    storeId String
    store   MerchantStore @relation(fields: [storeId], references: [id], onDelete: Cascade)

    syncType String
    result   String

    // Stats
    totalItems   Int
    successItems Int
    failedItems  Int

    // Details
    startedAt   DateTime  @default(now())
    completedAt DateTime?
    durationMs  Int?

    errorMessage String?
    errorDetails Json?

    // Metadata
    triggeredBy     String?
    triggeredByUser String?

    createdAt DateTime @default(now())

    @@index([storeId, syncType])
    @@index([startedAt])
    @@map("store_sync_logs")
}

// ============================================
// SECTION 4: LOGISTICS INFRASTRUCTURE
// ============================================

model Address {
    id         String   @id
    merchantId String
    merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    label String?
    type  String

    name     String?
    phone    String?
    line1    String
    line2    String?
    city     String
    state    String
    pincode  String
    country  String  @default("India")
    landmark String?

    isDefault Boolean @default(false)

    latitude  Float?
    longitude Float?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    merchantDefaultLogisticsAsPickup MerchantLogistics[]          @relation("MerchantLogisticsDefaultPickup")
    merchantDefaultPreferencesPickup MerchantPreferences[]        @relation("MerchantDefaultPickup")
    storeCustomPreferencesPickup     MerchantStorePreferences[]   @relation("StoreCustomPickup")
    storePickupLogistics             StoreLogistics[]             @relation("StorePickupLogistics")
    storeReturnLogistics             StoreLogistics[]             @relation("StoreReturnLogistics")
    manifestPickups                  Manifest[]
    storePickupAddresses             MerchantStorePickupAddress[]

    @@index([merchantId])
    @@index([merchantId, type])
    @@index([isDefault])
    @@map("addresses")
}

model PackageProfile {
    id         String   @id
    merchantId String
    merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    label       String
    lengthCm    Float
    widthCm     Float
    heightCm    Float
    weightGrams Int

    description String?
    isDefault   Boolean @default(false)
    isReusable  Boolean @default(true)

    metadata Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    merchantDefaultLogistics   MerchantLogistics[]           @relation("MerchantLogisticsDefaultPackage")
    merchantDefaultPreferences MerchantPreferences[]         @relation("MerchantDefaultPackage")
    storeCustomPreferences     MerchantStorePreferences[]    @relation("StoreCustomPackage")
    storePackageLogistics      StoreLogistics[]              @relation("StorePackageLogistics")
    storePackageProfiles       MerchantStorePackageProfile[]

    @@index([merchantId])
    @@index([isDefault])
    @@map("package_profiles")
}

model MerchantLogistics {
    id         String   @id
    merchantId String   @unique
    merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    // Default Settings
    defaultPickupAddressId  String?
    defaultPackageProfileId String?
    defaultCourier          String?

    // Quote Preferences
    sortQuotesBy       String @default("PRICE")
    quoteCacheDuration Int    @default(15)

    // COD Settings
    codEnabled       Boolean @default(true)
    codMinOrderValue Float   @default(0)

    // Return Policy
    returnsEnabled       Boolean  @default(true)
    returnWindowDays     Int      @default(7)
    returnConditions     String[] @default([])
    returnShippingPaidBy String   @default("MERCHANT")
    qcRequired           Boolean  @default(false)
    qcTimeframeDays      Int      @default(2)

    exchangesEnabled   Boolean @default(false)
    exchangeWindowDays Int     @default(7)

    // Settlement
    remittanceCycle  String @default("WEEKLY")
    slaThresholdDays Int    @default(7)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    defaultPickupAddress  Address?        @relation("MerchantLogisticsDefaultPickup", fields: [defaultPickupAddressId], references: [id])
    defaultPackageProfile PackageProfile? @relation("MerchantLogisticsDefaultPackage", fields: [defaultPackageProfileId], references: [id])

    @@map("merchant_logistics")
}

model MerchantStorePickupAddress {
    id        String  @id
    storeId   String
    addressId String
    isDefault Boolean @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    store   MerchantStore @relation(fields: [storeId], references: [id], onDelete: Cascade)
    address Address       @relation(fields: [addressId], references: [id], onDelete: Cascade)

    @@unique([storeId, addressId])
    @@index([storeId])
    @@map("merchant_store_pickup_addresses")
}

model MerchantStorePackageProfile {
    id               String  @id
    storeId          String
    packageProfileId String
    isDefault        Boolean @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    store          MerchantStore  @relation(fields: [storeId], references: [id], onDelete: Cascade)
    packageProfile PackageProfile @relation(fields: [packageProfileId], references: [id], onDelete: Cascade)

    @@unique([storeId, packageProfileId])
    @@index([storeId])
    @@map("merchant_store_package_profiles")
}

// ============================================
// SECTION 5: COURIER & SHIPPING PARTNERS
// ============================================

model CourierPartner {
    id         String @id
    name       String
    code       String @unique
    apiBaseUrl String

    authType         AUTH_TYPE @default(API_KEY)
    credentialSource Json

    headers          Json?
    tokenConfig      Json?
    supportsCOD      Boolean @default(true)
    supportsTracking Boolean @default(true)
    webhookUrl       String?

    isActive Boolean @default(true)
    isGlobal Boolean @default(true)

    imageUrl       String?
    customMappings Json?
    serviceRegions Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    services CourierService[]
    quotes   CourierQuote[]

    @@index([isActive])
    @@map("courier_partners")
}

model CourierService {
    id               String         @id
    courierPartnerId String
    name             String
    externalCode     String
    mode             TRANSPORT_MODE
    deliveryType     DELIVERY_TYPE
    serviceLevel     String

    isActive              Boolean @default(true)
    isGlobal              Boolean @default(true)
    estimatedDeliveryDays Int?
    maxCodAmount          Float?
    minWeight             Float?
    maxWeight             Float?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    courierPartner     CourierPartner               @relation(fields: [courierPartnerId], references: [id], onDelete: Cascade)
    quotes             CourierQuote[]
    merchantConfigs    MerchantCourierConfig[]
    storeConfigs       MerchantStoreCourierConfig[]
    pickupSlots        PickupSlot[]
    performanceMetrics CourierPerformanceMetrics[]
    manifests          Manifest[]

    @@index([courierPartnerId])
    @@index([isActive])
    @@map("courier_services")
}

model MerchantCourierConfig {
    id         String   @id
    merchantId String
    merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    courierServiceId String
    courierService   CourierService @relation(fields: [courierServiceId], references: [id], onDelete: Cascade)

    isEnabled Boolean @default(true)
    priority  Int     @default(0)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([merchantId, courierServiceId])
    @@index([merchantId])
    @@map("merchant_courier_configs")
}

model MerchantStoreCourierConfig {
    id               String  @id
    storeId          String
    courierServiceId String
    isEnabled        Boolean @default(true)
    labelOverride    String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    store          MerchantStore  @relation(fields: [storeId], references: [id], onDelete: Cascade)
    courierService CourierService @relation(fields: [courierServiceId], references: [id], onDelete: Cascade)

    @@unique([storeId, courierServiceId])
    @@index([storeId])
    @@map("merchant_store_courier_configs")
}

model PickupSlot {
    id               String @id
    courierServiceId String

    dayOfWeek String?
    startTime String
    endTime   String
    slotLabel String

    isActive         Boolean @default(true)
    maxPickupsPerDay Int?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    courierService CourierService @relation(fields: [courierServiceId], references: [id], onDelete: Cascade)

    @@index([courierServiceId])
    @@map("pickup_slots")
}

model CourierPerformanceMetrics {
    id               String  @id
    courierServiceId String
    merchantId       String?
    storeId          String?
    region           String?

    // Time Period
    periodStart DateTime
    periodEnd   DateTime

    // Performance Data
    totalShipments        Int
    successfulDeliveries  Int
    failedDeliveries      Int
    rtoCount              Int
    avgDeliveryDays       Float
    onTimeDeliveryPercent Float

    // Financial
    totalShippingCost Float
    avgShippingCost   Float
    totalRTOCharges   Float

    // Calculated Rates
    successRate Float
    rtoRate     Float

    calculatedAt DateTime @default(now())

    // Relations
    courierService CourierService @relation(fields: [courierServiceId], references: [id], onDelete: Cascade)
    merchant       Merchant?      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
    store          MerchantStore? @relation(fields: [storeId], references: [id], onDelete: Cascade)

    @@unique([courierServiceId, merchantId, storeId, region, periodStart])
    @@index([courierServiceId])
    @@index([merchantId])
    @@index([storeId])
    @@map("courier_performance_metrics")
}

// ============================================
// SECTION 6: LOGISTICS OPERATIONS
// ============================================

model Logistics {
    id              String  @id
    customerId      String?
    packageDetails  Json
    pickupAddress   Json
    dropoffAddress  Json
    estimatedCharge Float

    deliverySlaDays  Int?
    isReturnFlow     Boolean @default(false)
    merchantOverride Json?

    status LOGISTICS_STATUS @default(CREATED)

    currentLocation Json?
    lastUpdatedAt   DateTime?

    quoteFetchStatus Json?

    // Auto-Assignment
    autoAssigned       Boolean   @default(false)
    assignmentStrategy String?
    autoAssignedAt     DateTime?
    autoAssignReason   String?

    // Bulk Job Tracking
    bulkJobId String?

    // Pickup Scheduling
    preferredPickupDate DateTime?
    preferredPickupTime String?
    pickupScheduledAt   DateTime?
    pickupConfirmedAt   DateTime?
    pickupInstructions  String?

    selectedCourierId String? @unique
    orderId           String? @unique

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    customer        User?             @relation(fields: [customerId], references: [id], onDelete: SetNull)
    bulkJob         BulkLogisticsJob? @relation(fields: [bulkJobId], references: [id], onDelete: SetNull)
    selectedCourier CourierQuote?     @relation("SelectedCourier", fields: [selectedCourierId], references: [id])
    order           ShopOrder?        @relation(fields: [orderId], references: [id])
    quotes          CourierQuote[]
    shippings       Shipping[]

    @@index([customerId])
    @@index([status])
    @@index([bulkJobId])
    @@map("logistics")
}

model BulkLogisticsJob {
    id         String  @id
    merchantId String
    storeId    String?
    createdBy  String

    // Job Details
    totalOrders      Int
    processedOrders  Int @default(0)
    successfulOrders Int @default(0)
    failedOrders     Int @default(0)

    status BULK_JOB_STATUS @default(PENDING)

    // Assignment Strategy
    courierServiceId  String?
    autoSelect        Boolean @default(false)
    selectionStrategy String?

    // Filters
    filters Json?

    // Results
    orderIds String[]
    results  Json?
    errorLog Json?

    startedAt   DateTime?
    completedAt DateTime?
    createdAt   DateTime  @default(now())

    // Relations
    merchant  Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade)
    store     MerchantStore? @relation(fields: [storeId], references: [id], onDelete: Cascade)
    logistics Logistics[]

    @@index([merchantId])
    @@index([storeId])
    @@index([status])
    @@map("bulk_logistics_jobs")
}

model CourierQuote {
    id                    String         @id
    logisticsId           String
    courierCode           String
    courierName           String
    serviceName           String
    deliveryType          DELIVERY_TYPE?
    serviceLevel          String?
    shippingCharge        Float
    currency              String         @default("INR")
    estimatedDeliveryDays Int?
    estimatedPickupDate   DateTime?
    validTill             DateTime?

    // Fetch Metadata
    fetchedAt   DateTime  @default(now())
    cacheExpiry DateTime?
    fetchStatus String?
    errorReason String?

    // Delivery Details
    pickupTimeWindow     Json?
    expectedDeliveryDate String?
    expectedPODDate      String?
    originCity           String?
    destinationCity      String?
    originRegion         String?
    destinationRegion    String?
    serviceCenter        String?
    areaCode             String?
    zone                 String?
    mode                 String?
    additionalDays       Int?
    apexAdditionalDays   Int?
    groundAdditionalDays Int?
    edlMessage           Boolean?
    transitErrorMessage  String?

    // Weight & Charges
    actualWeight     Float?
    volumetricWeight Float?
    chargeableWeight Float?
    chargedBy        String?
    baseRate         Float?
    fuelSurcharge    Float?
    codCharge        Float?
    totalCharge      Float?

    // Features
    codSupported    Boolean @default(true)
    trackingSupport Boolean @default(true)
    labelOverride   String?
    rating          Float?

    courierPartnerId String?
    courierServiceId String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    logistics      Logistics       @relation(fields: [logisticsId], references: [id], onDelete: Cascade)
    selectedBy     Logistics?      @relation("SelectedCourier")
    courierPartner CourierPartner? @relation(fields: [courierPartnerId], references: [id], onDelete: SetNull)
    courierService CourierService? @relation(fields: [courierServiceId], references: [id], onDelete: SetNull)
    shippings      Shipping[]

    @@index([logisticsId])
    @@index([courierPartnerId])
    @@index([courierServiceId])
    @@map("courier_quotes")
}

model Shipping {
    id                     String  @id
    logisticsId            String?
    selectedCourierQuoteId String?

    trackingId     String?         @unique
    shippingSource SHIPPING_SOURCE @default(ORDER)

    deliveryAddress      Json
    deliveryInstructions String?

    expectedDeliveryDate DateTime?

    weight        Float?
    weightUnit    String? @default("kg")
    length        Float?
    width         Float?
    height        Float?
    dimensionUnit String? @default("cm")

    codAmount Float?

    status       DELIVERY_STATUS @default(PENDING)
    shippedAt    DateTime?
    deliveredAt  DateTime?
    returnedAt   DateTime?
    returnReason String?

    attemptCount   Int              @default(0)
    ndrReason      String?
    rtoInitiatedAt DateTime?
    trackingUrl    String?
    trackingStatus DELIVERY_STATUS?

    // RTO Tracking
    isRTO                   Boolean   @default(false)
    rtoReason               String?
    rtoStatus               String?
    rtoCompletedAt          DateTime?
    rtoCharges              Float?
    rtoChargesPaidBy        String?
    rtoDeductedFromMerchant Boolean   @default(false)
    rtoDeductionId          String?

    orderId String @unique

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    logistics            Logistics?             @relation(fields: [logisticsId], references: [id], onDelete: SetNull)
    selectedCourierQuote CourierQuote?          @relation(fields: [selectedCourierQuoteId], references: [id], onDelete: SetNull)
    order                ShopOrder              @relation(fields: [orderId], references: [id], onDelete: Cascade)
    verifications        DeliveryVerification[]
    documents            ShippingDocument[]
    trackingEvents       TrackingEvent[]
    ndrAttempts          NDRAttempt[]
    manifestShipments    ManifestShipment[]

    @@index([logisticsId])
    @@index([trackingId])
    @@index([selectedCourierQuoteId])
    @@index([status])
    @@map("shippings")
}

model DeliveryVerification {
    id         String    @id
    shippingId String
    otp        String
    verified   Boolean   @default(false)
    verifiedAt DateTime?
    verifiedBy String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    shipping Shipping @relation(fields: [shippingId], references: [id], onDelete: Cascade)

    @@index([shippingId])
    @@map("delivery_verifications")
}

model ShippingDocument {
    id          String        @id
    shippingId  String
    type        DOCUMENT_TYPE
    url         String
    generatedAt DateTime      @default(now())

    version  Int   @default(1)
    metadata Json?

    // Relations
    shipping Shipping @relation(fields: [shippingId], references: [id], onDelete: Cascade)

    @@index([shippingId])
    @@map("shipping_documents")
}

model TrackingEvent {
    id         String          @id
    shippingId String
    status     DELIVERY_STATUS
    timestamp  DateTime
    location   String?
    remarks    String?

    eventCode String?
    actor     String?

    // Relations
    shipping Shipping @relation(fields: [shippingId], references: [id], onDelete: Cascade)

    @@index([shippingId])
    @@index([timestamp])
    @@map("tracking_events")
}

model NDRAttempt {
    id            String @id
    shippingId    String
    attemptNumber Int    @default(1)

    // NDR Details
    ndrDate        DateTime @default(now())
    ndrReason      String
    ndrReasonCode  String?
    courierRemarks String?

    status NDR_STATUS @default(REPORTED)

    // Customer Response
    customerContacted   Boolean   @default(false)
    customerContactedAt DateTime?
    customerResponse    Json?

    // Reattempt
    reattemptScheduledAt DateTime?
    reattemptDate        DateTime?
    reattemptTimeSlot    String?
    reattemptAddress     Json?

    // Resolution
    resolvedAt     DateTime?
    resolutionType String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    shipping Shipping @relation(fields: [shippingId], references: [id], onDelete: Cascade)

    @@unique([shippingId, attemptNumber])
    @@index([shippingId])
    @@map("ndr_attempts")
}

model Manifest {
    id               String  @id
    manifestNumber   String  @unique
    merchantId       String
    storeId          String?
    courierServiceId String

    pickupDate      DateTime
    pickupTime      String?
    pickupAddressId String

    totalShipments Int
    totalWeight    Float
    totalCODAmount Float?

    status MANIFEST_STATUS @default(DRAFT)

    // Document
    manifestUrl String?
    generatedAt DateTime?

    // Handover Tracking
    handedOverAt     DateTime?
    handedOverBy     String?
    receivedBy       String?
    courierSignature String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    merchant       Merchant           @relation(fields: [merchantId], references: [id], onDelete: Cascade)
    store          MerchantStore?     @relation(fields: [storeId], references: [id], onDelete: Cascade)
    courierService CourierService     @relation(fields: [courierServiceId], references: [id], onDelete: Cascade)
    pickupAddress  Address            @relation(fields: [pickupAddressId], references: [id])
    shipments      ManifestShipment[]

    @@index([manifestNumber])
    @@index([merchantId, pickupDate])
    @@index([status])
    @@map("manifests")
}

model ManifestShipment {
    id         String @id
    manifestId String
    shippingId String

    waybillNumber String
    orderNumber   String
    weight        Float
    codAmount     Float?

    // Relations
    manifest Manifest @relation(fields: [manifestId], references: [id], onDelete: Cascade)
    shipping Shipping @relation(fields: [shippingId], references: [id], onDelete: Cascade)

    @@unique([manifestId, shippingId])
    @@index([manifestId])
    @@map("manifest_shipments")
}

// ============================================
// SECTION 7: PRODUCT & CART MANAGEMENT
// ============================================

model ShopProduct {
    id          String  @id
    merchantId  String
    storeId     String
    externalId  String  @unique
    source      String
    title       String
    description String?
    imageUrl    String?
    price       Float
    currency    String  @default("INR")

    // Dimensions
    weight Float?
    length Float?
    width  Float?
    height Float?

    // Inventory
    inventoryQty  Int?
    sku           String?
    barcode       String?
    isAvailable   Boolean   @default(true)
    lastFetchedAt DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    merchant   Merchant             @relation(fields: [merchantId], references: [id], onDelete: Cascade)
    store      MerchantStore        @relation(fields: [storeId], references: [id], onDelete: Cascade)
    variants   ShopProductVariant[]
    cartItems  ShopCartItem[]
    orderItems ShopOrderItem[]

    @@index([merchantId])
    @@index([storeId])
    @@index([externalId])
    @@map("shop_products")
}

model ShopProductVariant {
    id           String  @id
    productId    String
    externalId   String  @unique
    title        String
    price        Float
    sku          String?
    barcode      String?
    inventoryQty Int?
    isAvailable  Boolean @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    product    ShopProduct     @relation(fields: [productId], references: [id], onDelete: Cascade)
    orderItems ShopOrderItem[]
    cartItems  ShopCartItem[]

    @@index([productId])
    @@index([externalId])
    @@map("shop_product_variants")
}

model ShopCart {
    id     String     @id @default(cuid())
    status CartStatus @default(ACTIVE)

    userId String? @unique
    user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

    guestSessionTokenId String?            @unique
    guestSessionToken   GuestSessionToken? @relation(fields: [guestSessionTokenId], references: [id], onDelete: Cascade)

    expiresAt   DateTime?
    totalItems  Int       @default(0)
    totalAmount Float     @default(0)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    items ShopCartItem[]

    @@index([status])
    @@index([userId])
    @@index([guestSessionTokenId])
    @@map("shop_carts")
}

model ShopCartItem {
    id     String @id
    cartId String

    shopProductId        String
    shopProductVariantId String

    quantity      Int
    priceSnapshot Float
    metadata      Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    cart    ShopCart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
    product ShopProduct        @relation(fields: [shopProductId], references: [id], onDelete: Cascade)
    variant ShopProductVariant @relation(fields: [shopProductVariantId], references: [id], onDelete: Cascade)

    @@index([cartId])
    @@index([shopProductId])
    @@map("shop_cart_items")
}

model GuestSessionToken {
    id      String @id @default(cuid())
    token   String @unique
    guestId String

    guestInfo Json?
    expiresAt DateTime?
    revoked   Boolean   @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    shopCart         ShopCart?
    shopPayments     ShopPayment[]
    shopOrders       ShopOrder[]
    shopTransactions ShopTransaction[]
    shopOrderGroups  ShopOrderGroup[]

    @@index([token])
    @@index([guestId])
    @@map("guest_session_tokens")
}

// ============================================
// SECTION 8: ORDER MANAGEMENT
// ============================================

model ShopOrderGroup {
    id      String  @id
    buyerId String?

    guestSessionTokenId String?

    createdAt  DateTime           @default(now())
    externalId String?            @unique
    source     ORDER_GROUP_SOURCE @default(RAKSHASETU)

    status          ORDER_GROUP_STATUS @default(PENDING)
    totalAmount     Float              @default(0)
    currency        String             @default("INR")
    groupType       ORDER_GROUP_TYPE   @default(MARKETPLACE)
    groupNotes      String?
    deliverySummary Json?

    // Relations
    buyer             User?              @relation(fields: [buyerId], references: [id], onDelete: SetNull)
    guestSessionToken GuestSessionToken? @relation(fields: [guestSessionTokenId], references: [id], onDelete: SetNull)
    orders            ShopOrder[]
    payments          ShopPayment[]

    @@index([buyerId])
    @@index([guestSessionTokenId])
    @@index([createdAt])
    @@index([status])
    @@map("shop_order_groups")
}

model ShopOrder {
    id         String            @id
    externalId String?           @unique
    source     SHOP_ORDER_SOURCE
    merchantId String
    storeId    String

    name        String?
    createdAt   DateTime  @default(now())
    processedAt DateTime?
    syncedAt    DateTime?

    currency       String @default("INR")
    totalPrice     Float
    subtotalPrice  Float?
    totalTax       Float?
    totalDiscounts Float?

    financialStatus   PAYMENT_STATUS?
    fulfillmentStatus FULFILLMENT_STATUS?
    sourceName        String?

    paymentGateway String?
    discountCodes  Json?
    shippingLines  Json?

    note String?
    tags String?

    customerId    String?
    customerName  String?
    customerEmail String?
    customerPhone String?

    shippingAddress Json?
    billingAddress  Json?

    packageDetails Json?

    guestSessionTokenId String?

    status ORDER_STATUS @default(CREATED)

    paymentType    PAYMENT_METHOD?
    shippingCharge Float?
    codCharge      Float?
    platformFee    Float?

    isEscrowed   Boolean        @default(false)
    escrowStatus ESCROW_STATUS?
    escrowMeta   Json?

    shopOrderGroupId String?

    // Relations
    merchant          Merchant           @relation(fields: [merchantId], references: [id], onDelete: Cascade)
    store             MerchantStore      @relation(fields: [storeId], references: [id], onDelete: Cascade)
    guestSessionToken GuestSessionToken? @relation(fields: [guestSessionTokenId], references: [id], onDelete: SetNull)
    orderGroup        ShopOrderGroup?    @relation(fields: [shopOrderGroupId], references: [id], onDelete: SetNull)
    lineItems         ShopOrderItem[]
    transaction       ShopTransaction?
    dispute           ShopDisputeTicket?
    refunds           ShopRefund[]
    returnRequests    ReturnRequest[]
    shipping          Shipping?
    logistics         Logistics?

    @@index([merchantId])
    @@index([storeId])
    @@index([externalId])
    @@index([shopOrderGroupId])
    @@index([status])
    @@map("shop_orders")
}

model ShopOrderItem {
    id        String  @id
    orderId   String
    productId String
    variantId String?

    externalId        String
    title             String
    quantity          Int
    price             Float
    sku               String?
    fulfillmentStatus String?

    isReturnable     Boolean @default(true)
    returnWindowDays Int?

    // Relations
    order          ShopOrder           @relation(fields: [orderId], references: [id], onDelete: Cascade)
    product        ShopProduct         @relation(fields: [productId], references: [id], onDelete: Cascade)
    variant        ShopProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
    returnRequests ReturnRequest[]

    @@index([orderId])
    @@index([productId])
    @@map("shop_order_items")
}

model ShopTransaction {
    id      String @id
    orderId String @unique

    buyerPaid       Float
    chargesDeducted Float
    sellerReceives  Float

    platformFee      Float?
    platformFeePayer SHOP_PLATFORM_FEE_PAYER @default(MERCHANT)
    shippingCharge   Float?
    codCharge        Float?

    status                   TRANSACTION_STATUS @default(INITIATED)
    releaseRequested         Boolean            @default(false)
    releaseRequestedAt       DateTime?
    releaseRequestedByType   USER_ROLE?
    releaseRequestedById     String?
    releaseRequestedMeta     Json?
    releaseApprovedByAdmin   Boolean            @default(false)
    releaseApprovedAt        DateTime?
    releaseApprovedByAdminId String?
    releaseNotes             String?

    releaseRequestedByGuestTokenId String?

    codRemittanceDueAt DateTime?
    codRemittedAt      DateTime?
    codRemittanceNotes String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    order                        ShopOrder          @relation(fields: [orderId], references: [id], onDelete: Cascade)
    releaseRequestedByGuestToken GuestSessionToken? @relation(fields: [releaseRequestedByGuestTokenId], references: [id], onDelete: SetNull)
    refunds                      ShopRefund[]

    @@index([orderId])
    @@index([status])
    @@map("shop_transactions")
}

model ShopPayment {
    id String @id

    buyerId    String?
    merchantId String?

    amount   Float
    currency String @default("INR")

    method PAYMENT_METHOD
    status PAYMENT_STATUS       @default(INITIATED)
    source PAYMENT_ORDER_SOURCE @default(SHOP)

    razorpayOrderId   String?
    razorpayPaymentId String?
    providerTxnId     String?

    errorCode    String?
    errorMessage String?
    metadata     Json?

    paidAt  DateTime?
    attempt Int       @default(1)

    codCollected   Boolean   @default(false)
    codCollectedAt DateTime?

    guestSessionTokenId String?
    orderGroupId        String  @unique

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    buyer             User?              @relation(fields: [buyerId], references: [id], onDelete: SetNull)
    merchant          Merchant?          @relation(fields: [merchantId], references: [id], onDelete: SetNull)
    guestSessionToken GuestSessionToken? @relation(fields: [guestSessionTokenId], references: [id], onDelete: SetNull)
    shopOrderGroup    ShopOrderGroup     @relation(fields: [orderGroupId], references: [id], onDelete: Cascade)

    @@index([buyerId])
    @@index([merchantId])
    @@index([status])
    @@map("shop_payments")
}

// ============================================
// SECTION 9: RETURNS & DISPUTES
// ============================================

model ReturnRequest {
    id                String        @id
    orderId           String
    itemId            String
    reason            RETURN_REASON
    status            RETURN_STATUS @default(REQUESTED)
    refundAmount      Float?
    exchangeVariantId String?

    pickupScheduledAt DateTime?
    pickupCourierCode String?
    refundSynced      Boolean   @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    order ShopOrder     @relation(fields: [orderId], references: [id], onDelete: Cascade)
    item  ShopOrderItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

    @@index([orderId])
    @@index([status])
    @@map("return_requests")
}

model ShopDisputeTicket {
    id      String @id
    orderId String @unique

    raisedBy     USER_ROLE
    raisedById   String?
    customerInfo Json?

    reason            String
    status            DISPUTE_STATUS @default(PENDING)
    resolution        String?
    createdAt         DateTime       @default(now())
    updatedAt         DateTime       @updatedAt
    resolvedAt        DateTime?
    resolvedByAdminId String?

    // Relations
    order           ShopOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)
    resolvedByAdmin Admin?      @relation(fields: [resolvedByAdminId], references: [id], onDelete: SetNull)
    refund          ShopRefund?

    @@index([orderId])
    @@index([status])
    @@map("shop_dispute_tickets")
}

model ShopRefund {
    id            String  @id
    disputeId     String? @unique
    orderId       String?
    transactionId String?

    refundedAt         DateTime?
    amount             Float
    refundMethod       REFUND_METHOD
    notes              String?
    status             REFUND_STATUS        @default(PENDING)
    refundAmountStatus REFUND_AMOUNT_STATUS @default(NONE)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    dispute     ShopDisputeTicket? @relation(fields: [disputeId], references: [id], onDelete: SetNull)
    order       ShopOrder?         @relation(fields: [orderId], references: [id], onDelete: Cascade)
    transaction ShopTransaction?   @relation(fields: [transactionId], references: [id], onDelete: Cascade)

    @@index([disputeId])
    @@index([orderId])
    @@index([status])
    @@map("shop_refunds")
}

// ============================================
// SECTION 10: MARKETPLACE (P2P TRADING)
// ============================================

model SellerAccount {
    id     String @id
    userId String @unique

    earningsBalance Float @default(0.0)
    creditBalance   Float @default(0.0)
    totalEarnings   Float @default(0.0)
    totalWithdrawn  Float @default(0.0)
    totalCharges    Float @default(0.0)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
    deductions SellerDeduction[]

    @@map("seller_accounts")
}

model SellerDeduction {
    id              String           @id
    sellerAccountId String
    orderId         String
    type            DEDUCTION_TYPE
    amount          Float
    status          DEDUCTION_STATUS

    createdAt DateTime @default(now())

    // Relations
    sellerAccount SellerAccount @relation(fields: [sellerAccountId], references: [id], onDelete: Cascade)

    @@index([sellerAccountId])
    @@map("seller_deductions")
}

model Listing {
    id           String         @id
    sellerId     String
    type         LISTING_TYPE
    title        String
    description  String
    category     String
    subCategory  String?
    price        Float
    status       LISTING_STATUS @default(ACTIVE)
    tags         String[]
    metadata     Json?
    media        Json?
    externalLink String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    seller        User           @relation(fields: [sellerId], references: [id], onDelete: Cascade)
    connects      Connects[]
    conversations Conversation[]
    orders        Order[]
    orderDetails  OrderDetails[]

    @@index([sellerId])
    @@index([status])
    @@index([type])
    @@map("listings")
}

model Connects {
    id        String         @id
    userId    String
    listingId String?
    sellerId  String
    message   String?        @db.VarChar(500)
    status    CONNECT_STATUS @default(PENDING)

    rejectReason String? @db.VarChar(500)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    user    User     @relation("user", fields: [userId], references: [id], onDelete: Cascade)
    seller  User     @relation("seller", fields: [sellerId], references: [id], onDelete: Cascade)
    listing Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

    @@index([userId])
    @@index([sellerId])
    @@index([listingId])
    @@map("connects")
}

model Order {
    id        String                   @id
    orderType ORDER_TYPE
    buyerId   String
    sellerId  String
    status    MARKETPLACE_ORDER_STATUS @default(PENDING)
    notes     String?

    orderStatus  ORDER_FLOW_STATUS @default(PENDING)
    rejectReason String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    listingId String?

    // Relations
    buyer         User           @relation("order_buyer", fields: [buyerId], references: [id], onDelete: Cascade)
    seller        User           @relation("order_seller", fields: [sellerId], references: [id], onDelete: Cascade)
    listing       Listing?       @relation(fields: [listingId], references: [id], onDelete: SetNull)
    details       OrderDetails?
    transaction   Transaction?
    conversations Conversation[]
    payments      Payment[]
    dispute       DisputeTicket?
    refunds       Refund[]

    @@index([buyerId])
    @@index([sellerId])
    @@index([listingId])
    @@index([status])
    @@map("orders")
}

model OrderDetails {
    id String @id

    orderType ORDER_TYPE

    listingId      String?
    listingDetails Json?
    customDetails  Json?

    totalAmount      Float
    platformFee      Float
    platformFeePayer PLATFORM_FEE_PAYER @default(BUYER)
    sellerReceives   Float
    buyerAmount      Float

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    orderId String @unique

    // Relations
    listing          Listing?           @relation(fields: [listingId], references: [id], onDelete: SetNull)
    order            Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)
    orderAttachments orderAttachments[]

    @@map("order_details")
}

model orderAttachments {
    id             String @id
    orderDetailsId String

    type     String
    url      String
    name     String
    publicId String

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    OrderDetails OrderDetails @relation(fields: [orderDetailsId], references: [id], onDelete: Cascade)

    @@index([orderDetailsId])
    @@map("order_attachments")
}

model Transaction {
    id      String @id
    orderId String @unique

    buyerPaid       Float
    chargesDeducted Float
    sellerReceives  Float

    status                   TRANSACTION_STATUS @default(INITIATED)
    releaseRequested         Boolean            @default(false)
    releaseRequestedAt       DateTime?
    releaseRequestedByType   USER_ROLE?
    releaseRequestedById     String?
    releaseRequestedMeta     Json?
    releaseApprovedByAdmin   Boolean            @default(false)
    releaseApprovedAt        DateTime?
    releaseApprovedByAdminId String?
    releaseNotes             String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    order    Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
    payments Payment[]
    refunds  Refund[]

    @@index([orderId])
    @@index([status])
    @@map("transactions")
}

model Payment {
    id String @id

    orderId       String
    transactionId String
    buyerId       String
    sellerId      String

    amount   Float
    currency String @default("INR")

    method PAYMENT_METHOD @default(PREPAID)
    status PAYMENT_STATUS @default(INITIATED)

    razorpayOrderId   String?
    razorpayPaymentId String?
    providerTxnId     String?

    errorCode    String?
    errorMessage String?

    metadata Json?

    paidAt  DateTime?
    attempt Int       @default(1)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
    order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
    buyer       User?       @relation("PaymentBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
    seller      User?       @relation("PaymentSeller", fields: [sellerId], references: [id], onDelete: Cascade)

    @@index([orderId, transactionId])
    @@index([buyerId])
    @@index([sellerId])
    @@map("payments")
}

model DisputeTicket {
    id      String @id
    orderId String @unique

    raisedBy DISPUTE_ROLE

    raisedById   String
    raisedByUser User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    reason            String
    status            DISPUTE_STATUS @default(PENDING)
    resolution        String?
    createdAt         DateTime       @default(now())
    updatedAt         DateTime       @updatedAt
    resolvedAt        DateTime?
    resolvedByAdminId String?
    resolvedByAdmin   Admin?         @relation("AdminDisputes", fields: [resolvedByAdminId], references: [id], onDelete: SetNull)
    userId            String

    // Relations
    order        Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
    conversation Conversation?
    refund       Refund?

    @@index([orderId])
    @@index([status])
    @@map("dispute_tickets")
}

model Refund {
    id            String  @id
    disputeId     String? @unique
    orderId       String?
    transactionId String?

    refundedAt         DateTime?
    amount             Float
    refundMethod       REFUND_METHOD
    notes              String?
    status             REFUND_STATUS        @default(PENDING)
    refundAmountStatus REFUND_AMOUNT_STATUS @default(NONE)
    createdAt          DateTime             @default(now())
    updatedAt          DateTime             @updatedAt

    // Relations
    dispute     DisputeTicket? @relation(fields: [disputeId], references: [id], onDelete: SetNull)
    order       Order?         @relation(fields: [orderId], references: [id], onDelete: Cascade)
    transaction Transaction?   @relation(fields: [transactionId], references: [id], onDelete: Cascade)

    @@index([disputeId])
    @@index([orderId])
    @@index([status])
    @@map("refunds")
}

// ============================================
// SECTION 11: COMMUNICATION SYSTEM
// ============================================

model Notification {
    id        String  @id
    userId    String
    title     String
    message   String
    type      String
    event     String
    link      String?
    data      Json?
    priority  Int     @default(1)
    delivered Boolean @default(false)
    read      Boolean @default(false)

    createdAt DateTime @default(now())

    // Relations
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([type])
    @@index([event])
    @@map("notifications")
}

model Conversation {
    id     String              @id
    type   CONVERSATION_TYPE
    stage  CONVERSATION_STAGE  @default(LISTING)
    status CONVERSATION_STATUS @default(ACTIVE)

    listingId String?
    orderId   String?
    disputeId String? @unique

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    listing      Listing?                  @relation(fields: [listingId], references: [id], onDelete: SetNull)
    order        Order?                    @relation(fields: [orderId], references: [id], onDelete: SetNull)
    dispute      DisputeTicket?            @relation(fields: [disputeId], references: [id], onDelete: SetNull)
    participants ConversationParticipant[]
    messages     Message[]

    @@index([listingId])
    @@index([orderId])
    @@index([disputeId])
    @@map("conversations")
}

model ConversationParticipant {
    id             String @id
    conversationId String

    participantType PARTICIPANT_TYPE
    participantId   String?
    customerInfo    Json?

    joinedAt DateTime @default(now())

    // Relations
    conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

    @@unique([conversationId, participantType, participantId])
    @@index([conversationId])
    @@map("conversation_participants")
}

model Message {
    id             String @id
    conversationId String

    senderType   PARTICIPANT_TYPE
    senderId     String?
    customerInfo Json?

    content     String
    attachments Json?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    deletedAt   DateTime?

    // Relations
    conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

    @@index([conversationId])
    @@map("messages")
}

// ============================================
// SECTION 12: FINANCIAL MANAGEMENT
// ============================================

model MerchantAccount {
    id         String   @id
    merchantId String   @unique
    merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    availableBalance Float  @default(0.0)
    pendingCharges   Float  @default(0.0)
    totalEarnings    Float  @default(0.0)
    totalWithdrawn   Float  @default(0.0)
    totalCharges     Float  @default(0.0)
    currency         String @default("INR")
    status           String @default("ACTIVE")

    payoutMethod    String?
    lastPayoutAt    DateTime?
    payoutFrequency String    @default("MANUAL")

    auditTrail Json?
    notes      String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    deductions         MerchantDeduction[]
    payoutTransactions PayoutTransaction[]

    @@map("merchant_accounts")
}

model MerchantDeduction {
    id                String @id
    merchantAccountId String
    merchantId        String

    referenceId String
    type        String
    amount      Float
    status      String  @default("PENDING")
    remarks     String?

    triggeredBy String    @default("SYSTEM")
    settledAt   DateTime?
    waivedBy    String?

    shippingId String?

    createdAt DateTime @default(now())

    // Relations
    merchantAccount MerchantAccount @relation(fields: [merchantAccountId], references: [id], onDelete: Cascade)
    merchant        Merchant        @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    @@index([merchantAccountId])
    @@index([merchantId])
    @@index([referenceId])
    @@map("merchant_deductions")
}

model PayoutTransaction {
    id                String @id
    merchantAccountId String

    amount        Float
    method        String
    status        String  @default("PENDING")
    externalTxnId String?
    referenceNote String?
    failureReason String?
    initiatedBy   String

    createdAt   DateTime  @default(now())
    processedAt DateTime?

    // Relations
    merchantAccount MerchantAccount @relation(fields: [merchantAccountId], references: [id], onDelete: Cascade)

    @@index([merchantAccountId])
    @@index([status])
    @@map("payout_transactions")
}

model PlatformFeeConfig {
    id       String  @id
    category String
    label    String
    feeType  String
    feeValue Float
    codFee   Float   @default(50)
    currency String  @default("INR")
    isActive Boolean @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([category])
    @@map("platform_fee_configs")
}

model MerchantPlatformFee {
    id         String @id
    merchantId String

    category String
    label    String
    feeType  String
    feeValue Float
    currency String  @default("INR")
    isActive Boolean @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    @@index([merchantId])
    @@index([category])
    @@map("merchant_platform_fees")
}

model StorePlatformFee {
    id      String @id
    storeId String

    category String
    label    String
    feeType  String
    feeValue Float
    currency String  @default("INR")
    isActive Boolean @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    store MerchantStore @relation(fields: [storeId], references: [id], onDelete: Cascade)

    @@index([storeId])
    @@index([category])
    @@map("store_platform_fees")
}

model PlatformFeeLog {
    id          String            @id @default(uuid())
    orderId     String
    merchantId  String?
    storeId     String?
    category    FEE_CATEGORY
    sourceLevel FEE_SOURCE_LEVEL
    sourceId    String?
    feeType     PLATFORM_FEE_TYPE
    feeValue    Float
    currency    String            @default("INR")
    label       String?
    appliedAt   DateTime          @default(now())

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([orderId])
    @@index([merchantId])
    @@index([storeId])
    @@map("platform_fee_logs")
}

model PlatformSetting {
    id        String     @id
    feeSource FEE_SOURCE @default(GLOBAL)
    feeType   FEE_TYPE   @default(PERCENTAGE)
    feeValue  Float      @default(10)
    updatedAt DateTime   @updatedAt

    @@map("platform_settings")
}

// ============================================
// END OF SCHEMA
// ============================================
